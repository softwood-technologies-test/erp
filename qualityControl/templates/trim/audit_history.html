{% extends 'quality_base.html' %}

{% block title %}
    Trim Audit History
{% endblock %}

{% block content %}
<div class="border border-black rounded bg-base-100 dark:bg-gray-900 p-4">
    <form action="{% url 'trimAudit' %}" method="get" class="grid grid-cols-6 gap-2 items-center">
        <!-- Supplier Dropdown -->
        <div class="col-span-1">
            <select id="supplierFilter" name="supplier" class="form-select form-select-sm rounded text-center border border-black w-full min-h-[2.5rem]">
                <option value="">Supplier</option>
            </select>
        </div>

        <!-- Inventory Dropdown -->
        <div class="col-span-1">
            <select id="inventoryFilter" name="inventory" class="form-select form-select-sm rounded text-center border border-black w-full min-h-[2.5rem]">
                <option value="">Inventory</option>
            </select>
        </div>

        <!-- Start Date -->
        <div class="col-span-1">
            <input type="date" id="startDate" name="startDate" value="{{ startDate|date:'Y-m-d' }}" class="form-control form-control-sm rounded text-center border border-black w-full min-h-[2.5rem]">
        </div>

        <!-- End Date -->
        <div class="col-span-1">
            <input type="date" id="endDate" name="endDate" value="{{ endDate|date:'Y-m-d' }}" class="form-control form-control-sm rounded text-center border border-black w-full min-h-[2.5rem]">
        </div>

        <!-- Approval Dropdown -->
        <div class="col-span-1">
            <select name="approval" class="form-select form-select-sm rounded text-center border border-black w-full min-h-[2.5rem]">
                <option value="null" {% if approval == None %}selected{% endif %}>All</option>
                <option value="true" {% if approval == True %}selected{% endif %}>Approved</option>
                <option value="false" {% if approval == False %}selected{% endif %}>Rejected</option>
            </select>
        </div>

        <!-- Filter Button -->
        <div class="col-span-1 flex justify-end">
            <button type="submit" class="btn btn-lg bg-black text-white hover:opacity-90 w-full min-h-[2.5rem] px-4 py-2 rounded">
                Filter
            </button>
        </div>
    </form>
</div>

<div id="AuditsTable" class="mt-4 border border-black rounded bg-base-100 dark">
    <table class="table-auto w-full border border-black text-center align-middle text-sm">
        <thead class="bg-black text-white">
            <tr>
                <th class="border border-black p-2">Receipt Date</th>
                <th class="border border-black p-2">Receipt #</th>
                <th class="border border-black p-2">Name</th>
                <th class="border border-black p-2">Supplier</th>
                <th class="border border-black p-2">Approval</th>
                <th class="border border-black p-2">Comments</th>
            </tr>
        </thead>
        <tbody class="even:bg-white-100 odd:bg-white">
            {% for data in audits %}
            <tr class="border border-black">
                <td class="border border-black p-2">{{ data.ReceiptDate }}</td>
                <td class="border border-black p-2">
                    <a href="/trims/audit/{{ data.RecInventory }}/edit" class="text-blue-600 hover:underline">
                        {{ data.ReceiptNumber }}
                    </a>
                </td>
                <td class="border border-black p-2">{{ data.Name }}</td>
                <td class="border border-black p-2">{{ data.Supplier }}</td>
                <td class="border border-black p-2">
                    {% if data.Approval %}
                        <span class="text-green-600 font-semibold">Approved</span>
                    {% else %}
                        <span class="text-red-600 font-semibold">Rejected</span>
                    {% endif %}
                </td>
                <td class="border border-black p-2">{{ data.QualityComments }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    window.addEventListener('load', async () => {
        showLoadingIcon();

        const supplierRes = await fetch('/options/suppliers');
        const suppliers = await supplierRes.json();
        await appendOptions('supplierFilter', suppliers, '{{ supplier }}');

        const inventoryRes = await fetch('/options/inventories?group=Trim');
        const inventories = await inventoryRes.json();
        await appendOptions('inventoryFilter', inventories, '{{ inventory }}');

        $("#supplierFilter").chosen({ search_contains: true, width: "100%" });
        $("#inventoryFilter").chosen({ search_contains: true, width: "100%" });

        hideLoadingIcon();
    });

    async function appendOptions(selectId, items, selectedValue) {
        const select = document.getElementById(selectId);
        select.innerHTML += items.map(item => {
            const selected = item === selectedValue ? 'selected' : '';
            return `<option value="${item}" ${selected}>${item}</option>`;
        }).join('');
    }

    function showLoadingIcon() {
        // Optional spinner
    }

    function hideLoadingIcon() {
        // Optional hide
    }
</script>
{% endblock %}
