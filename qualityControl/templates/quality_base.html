<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{% static 'Logo 3x.png' %}" />
    <title>{% block title %}Fashion OS{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 20;
        font-size: 14px;
        cursor: pointer;
      }
    </style>

    <!-- Custom Styles and Libraries -->
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link href="{% static 'chosen/chosen.css' %}" rel="stylesheet" />
    <script src="{% static 'chosen/chosen.jquery.min.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-datetimepicker@2.5.20/build/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
  </head>

  <body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-200">
    <!-- Navbar -->
    <nav class="{{ theme.navigationBar }} px-6 py-4 flex justify-between items-center">
      <div class="flex space-x-6">
        <a href="/quality" class="{{ theme.hyperLink }}">Dashboard</a>

        <div class="relative group">
          <span class="{{ theme.hyperLink }}">Fabric</span>
        </div>

        <div class="relative group">
          <span class="{{ theme.hyperLink }}">Trims</span>
          <ul class="absolute hidden group-hover:block bg-white dark:bg-gray-800 border mt-2 shadow rounded z-10">
            <li><a class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700" href="{% url 'pendingTrimAudit' %}">Pending Audits</a></li>
            <li><a class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700" href="{% url 'trimAudit' %}">Audit History</a></li>
          </ul>
        </div>

        <div class="relative group">
          <span class="{{ theme.hyperLink }}">Production</span>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        {% if user.is_authenticated %}
        <span class="text-sm">Logged in as {{ user.first_name }} |</span>
        <a href="/logout" class="{{ theme.hyperLink }}">Logout</a>
        {% else %}
        <a href="/login" class="{{ theme.hyperLink }}">Login</a>
        {% endif %}
        <a href="/" class="{{ theme.hyperLink }}">Go to Main</a>
      </div>
    </nav>

    <!-- Message Container -->
    <div id="message-container" class="p-4"></div>

    <!-- Main Body -->
    <main class="{{ theme.pageBody }}">
      {% block content %}{% endblock %}
    </main>

    <!-- Loading Icon -->
    <div id="loadingIcon" hidden class="fixed z-50 top-0 left-0 w-full h-full bg-black bg-opacity-20 flex items-center justify-center">
      <div class="{{ theme.loadingIcon }}"></div>
    </div>

    <!-- Dropdown Modal -->
    <div id="dropdown" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div class="{{ theme.dialogBox }}">
        <div class="{{ theme.dialogBoxHeader }}">
          <h3 class="{{ theme.dialogBoxTitle }}">Select an Option</h3>
        </div>
        <div class="{{ theme.dialogBoxBody }}">
          <select id="id_selectDropDown" class="{{ theme.dropdown }}"></select>
        </div>
        <div class="{{ theme.dialogBoxFooter }}">
          <button class="{{ theme.buttonSecondary }}" onclick="hideModal()">OK</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
        crossorigin="anonymous">
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

    <script>    //To add the options for selects
      async function appendOptions (elementId, options, selected=null) {
          try {
            const element = document.getElementById(elementId);    
            element.innerHTML = ''; 

            const fragment = document.createDocumentFragment();

            options.forEach(optionData => {
              const option = document.createElement('option');
              option.text = optionData.text;
              option.value = optionData.value;
              if (optionData.value == selected) {
                  option.selected = true;
              }
              fragment.appendChild(option);
            });
    
            element.appendChild(fragment);
          } catch (error) {
            showMessage(`An Error occured: `+error);
          }
      }
    </script>

    <script>    //To show message to a user
      function showMessage(message, timeOut = 3) {
        //Get the container element
        const messageContainer = document.getElementById('message-container');

        // Create a new alert element
        const messageElement = document.createElement('div');
        //Set the correct bootstap class
        messageElement.classList.add('alert', 'alert-dismissible', 'fade', 'show');
        messageElement.setAttribute('role', 'alert');
        
        //Add a the message and close button to the message.
        messageElement.innerHTML = `
            <span>${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        //Add the message element to the container
        messageContainer.appendChild(messageElement);

        //close the message automatically after given number of seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(messageElement);
            bsAlert.close();
          },
          timeOut * 1000
        );
      }
    </script>

    <script>  //To show/hide loading icon to user
      function showLoadingIcon(top=100, left=10, zIndex=9999) {
        const loadingIcon = document.getElementById('loadingIcon');

        loadingIcon.style.top = `${top}px`;
        loadingIcon.style.left = `${left}px`;
        loadingIcon.style.zIndex = zIndex;

        loadingIcon.removeAttribute('hidden');
      }

      function hideLoadingIcon() {
        const loadingIcon = document.getElementById('loadingIcon');

        loadingIcon.setAttribute('hidden','');
      }
    </script>

    <script>  //To show options dialogue box
      function showDropDown(options, onOkFunction, selected=null, searchBox=false) {
        const dialogBox = document.getElementById('dropdown');

        const dropdown = dialogBox.children[0].children[0].children[1].children[0].children[0];
        dropdown.innerHTML = '';

        for (const option of options) {
          const newOption = document.createElement('option');
          newOption.text = option.text;
          newOption.value = option.value;

          if (newOption.value === selected) {
            newOption.selected = true;
          } else {
            newOption.selected = false;
          }
          dropdown.appendChild(newOption);
        }

        //Set the function to call whent the OK button is called
        const okButton = dialogBox.children[0].children[0].children[2].children[0];
        okButton.onclick = onOkFunction;

        if (searchBox) {
          if ($(dropdown).hasClass("chosenSelect")) { // Check if Chosen is already initialized
            $(dropdown).trigger("chosen:updated"); // If so, just update
          } else {
              $(dropdown).chosen({
                  search_contains: true,
                  width: "100%"
              }).addClass("chosenSelect"); //Add a class to check if it has been initalized
          }
        }

        //convert the table to a bootstrap modal and show it to user.
        new bootstrap.Modal(dialogBox).show();
      }
    </script>

    <script>  //To add or remove rows from tables 
      async function addRow (source) {
        //Remove the search box from elements
        removeSearchBox();
        
        const rowToCopy = source.parentElement.parentElement;
        const tableData = rowToCopy.parentElement     //Fetch the table body
        
        const copy = rowToCopy.cloneNode(true);     //Create a copy of the row

        // Clear written text that the copy got from source row
        for (const child of copy.children) {
          //Get the type of element in row
          const tag = child.children[0].tagName;

          if (tag === 'INPUT') {
            //Set the value to blank if it is an input box
            child.children[0].value = '';
          } else if (tag === 'SELECT') {
            //deselect all options if it is a selection box
            child.children[0].selectedIndex = -1;
          }
        }
        
        //Insert the row after the clicked row
        tableData.insertBefore(copy, rowToCopy.nextSibling);
        
        //Change the serial numbers of the button for future usage
        const rows = tableData.children;
        for (let i=0;i<rows.length;i++) {
            rows[i].setAttribute("row",i);
        }
        
        addSearchBox();

        //Reset the sequence in any column named Sequence
        const sequences = tableData.querySelectorAll('[name*="Sequence"]')
        let previousSequence = 0;
        for (const sequence of sequences) {
            sequence.value = previousSequence+1;
            previousSequence = parseInt(sequence.value);
        }
      }

      async function removeRow (source, minRows = 0 ) {
        const tableData = source.parentElement.parentElement.parentElement;     //Fetch the table body   
        
        //Don't delete the row if it is the only one
        if (tableData.children.length < (minRows+3)) {
            alert("This is the last row. You cannot delete it!");
            return ;
        }

        const rowToRemove = source.parentElement.parentElement;    //Fetch the row out of the table
        const rowNum = parseInt(rowToRemove.getAttribute('row'));

        let dataFlag = false;               //Flag to check if there is data in the row

        const inputs = rowToRemove.querySelectorAll ("input");      //All the columns with inputs
        const selects = rowToRemove.querySelectorAll ("select");    //All the columns with selection options
        const combined = [...inputs, ...selects];                 //Combined inputs and selects

        for (const element of combined) {
            const deletable = element.parentElement.getAttribute("deletable") === "true";
            if (element.value && !deletable) {  
                dataFlag = true;                            //Set flag true if there is data in an element
                break;    
            }
        }
        
        if (dataFlag) {                 //Give warining if the dataflag is true.
            const removeFlag = confirm("There is data here. Are you sure you want to remove it?");
            if (!removeFlag) {          //User doesn't select OK.
                return ;
            }
        }

        rowToRemove.remove();           //Remove the row

        //Reset the serial in the buttons below the deleted row
        let rows = tableData.children;
        for (let i=rowNum;i<rows.length;i++) {
            rows[i].setAttribute("row",i);
        }

        //Reset the sequence in any column named Sequence
        const sequences = tableData.querySelectorAll('[name*="Sequence"]')
        let previousSequence = 0;
        for (const sequence of sequences) {
            sequence.value = previousSequence+1;
            previousSequence = parseInt(sequence.value);
        }
      }
    </script>

    <script>  //To add or remove search box
      function removeSearchBox() {
        //The keyword that is common in all search boxes
        const keyword = "chosen";
        //Get elements that contain the key word.
        const searchBoxNodes = document.querySelectorAll(`[${keyword}*='true']`);

        //Remove the search box from 
        for (const node of searchBoxNodes) {
            //Get the id of the seletion element
            const selectId = node.children[0].id;
            
            //Get the id of the selection box associated with selection element. It'll always be selectid_keyword
            const boxId = selectId+"_"+keyword;
    
            //Remove the selection box and destroy the script associated with it.
            document.getElementById(boxId).remove();
            $("#"+selectId).chosen("destroy"); 
        }
      }
      
      async function addSearchBox() {
        //The keyword that is common in all search boxes
        const keyword = "chosen";
        //Get elements that contain the key word.
        const searchBoxNodes = document.querySelectorAll(`[${keyword}*='true']`);

        //Add search box to all nodes
        for (const node of searchBoxNodes) {
          //Get the row number of the element
          const row = node.parentElement.getAttribute("row")
          //Get the drop down inside the element
          const dropdown = node.children[0];
          
          //Get the id of the drop down. To make it unique, we preset it in the format column_row.
          let id = dropdown.getAttribute("id");
          
          //Get the position of the last _ in the id.
          const trimAfter = id.lastIndexOf("_");

          //If _ exists and isn't at start of id, get the part after _.
          if (trimAfter > 2) {
            id = id.substring(0, trimAfter);
          }
          
          //Set the id to new row number and set it on the dropdown
          id = `${id}_${row}`;
          dropdown.setAttribute('id', id);

          //Apply the search box on the element, with the new ID.
          $("#"+id).chosen({
            search_contains: true,
            width: `93%`
          });
        }
      }
    </script>

    <script> //To handle warning for unsaved data
      //The if is in response to a bug, where it wouldn't define unsavedDataFlag while replacing html
      if (typeof unsavedDataFlag === 'undefined') {
        let unsavedDataFlag = false;
      }

      //Show warning to user if there is unsaved data.
      window.addEventListener('beforeunload', (event) => {
        if (unsavedDataFlag) {
          event.preventDefault(); // For some older browsers
          event.returnValue = ''; // For chrome or firefox
          return ''; // for Safari
        }
      });
    </script>
  </body>
</html>