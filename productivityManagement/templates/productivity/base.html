<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
      <link rel="icon" href="{% static 'Logo 3x.png' %}">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
          crossorigin="anonymous">
      <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
      
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
      <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

      <link rel="stylesheet" href="{% static 'style.css' %}">
      
      <link href="{% static 'chosen/chosen.css' %}" rel="stylesheet" />
      <script src="{% static 'chosen/chosen.jquery.min.js' %}"></script>
      
      <script src="https://cdn.jsdelivr.net/npm/jquery-datetimepicker@2.5.20/build/jquery.datetimepicker.full.min.js"></script>
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">

      
      <title>
          {% block title %} Fashion OS {% endblock %}
      </title>
      
      <!--Icons from Google fonts-->
      <div>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
        <style>
          .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 20;
            font-size: 14px;
            cursor: pointer;
          }
        </style>
      </div>
  </head>
  
  <body> 
    <!--Navigation Bar-->
    <nav class="{{theme.navigationBar}}">  
        <div class="container-fluid">
          <div>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="/quality">Dashboard</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Presets</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'threadConsumption' %}">Thread Usage</a></li>
                  <li><a class="dropdown-item" href="{% url 'stitchingOBs' %}">Stitching OB</a></li>
                  <li><a class="dropdown-item" href="{% url 'washingRecipies' %}">Wash Recipe</a></li>
                  <li><a class="dropdown-item" href="{% url 'finishingOBs' %}">Finishing OB</a></li>
                  <li><a class="dropdown-item" href="{% url 'operations' %}">Operations Bank</a></li>
                </ul>
              </li>
            </ul>
          </div>
          <div>
            <ul class="navbar-nav">
              {% if user.is_authenticated %}
              <span class="navbar-text">Logged in as {{user.first_name}} | </span>
              <li class="nav-item">
                <a class="nav-link" href="/logout">Logout</a>
              </li>
              {% else %}
              <li class="nav-item">
                <a class="nav-link" href="/login">Login</a>
              </li>
              {% endif %}
              <li class="nav-item">
                <a class="nav-link" href="/">Go to Main</a>
              </li>
            </ul>
          </div>
      </div> 
    </nav>
        
    <!--Message Box-->
    <div id="message-container"></div>
    
    <!--Main Body-->
    <div class="{{theme.pageBody}}">
        {% block content %} {% endblock %}
    </div>

    <!--Loading Animiation-->
    <div style="position: fixed;" id="loadingIcon" hidden>
      <div class="{{theme.loadingIcon}}">
      </div>
    </div>

    <!--Simple drop down-->
    <div class="modal fade" id="dropdown" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="{{theme.dialogBox}}">
        <div class="modal-content">
          <div class="{{theme.dialogBoxHeader}}">
            <div class="{{theme.dialogBoxTitle}}" id="modalLabel">
              Select an Option
            </div>
          </div>
          <div class="{{theme.dialogBoxBody}}">
            <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}">
              <select class="{{theme.dropdown}}" id="id_selectDropDown"></select>
            </div>
          </div>
          <div class="{{theme.dialogBoxFooter}}">
            <button type="button" class="{{theme.buttonSecondary}}" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
        crossorigin="anonymous">
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

    <script>    //To add the options for selects
      async function appendOptions (elementId, options, selected=null) {
          try {
            const element = document.getElementById(elementId);    
            element.innerHTML = ''; 

            const fragment = document.createDocumentFragment();

            options.forEach(optionData => {
              const option = document.createElement('option');
              option.text = optionData.text;
              option.value = optionData.value;
              if (optionData.value == selected) {
                  option.selected = true;
              }
              fragment.appendChild(option);
            });
    
            element.appendChild(fragment);
          } catch (error) {
            showMessage(`An Error occured: `+error);
          }
      }
    </script>

    <script>    //To show message to a user
      function showMessage(message, timeOut = 3) {
        //Get the container element
        const messageContainer = document.getElementById('message-container');

        // Create a new alert element
        const messageElement = document.createElement('div');
        //Set the correct bootstap class
        messageElement.classList.add('alert', 'alert-dismissible', 'fade', 'show');
        messageElement.setAttribute('role', 'alert');
        
        //Add a the message and close button to the message.
        messageElement.innerHTML = `
            <span>${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        //Add the message element to the container
        messageContainer.appendChild(messageElement);

        //close the message automatically after given number of seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(messageElement);
            bsAlert.close();
          },
          timeOut * 1000
        );
      }
    </script>

    <script>  //To show/hide loading icon to user
      function showLoadingIcon(top=100, left=10, zIndex=9999) {
        const loadingIcon = document.getElementById('loadingIcon');

        loadingIcon.style.top = `${top}px`;
        loadingIcon.style.left = `${left}px`;
        loadingIcon.style.zIndex = zIndex;

        loadingIcon.removeAttribute('hidden');
      }

      function hideLoadingIcon() {
        const loadingIcon = document.getElementById('loadingIcon');

        loadingIcon.setAttribute('hidden','');
      }
    </script>

    <script>  //To show options dialogue box
      function showDropDown(options, onOkFunction, selected=null, searchBox=false) {
        const dialogBox = document.getElementById('dropdown');

        const dropdown = dialogBox.children[0].children[0].children[1].children[0].children[0];
        dropdown.innerHTML = '';

        for (const option of options) {
          const newOption = document.createElement('option');
          newOption.text = option.text;
          newOption.value = option.value;

          if (newOption.value === selected) {
            newOption.selected = true;
          } else {
            newOption.selected = false;
          }
          dropdown.appendChild(newOption);
        }

        //Set the function to call whent the OK button is called
        const okButton = dialogBox.children[0].children[0].children[2].children[0];
        okButton.onclick = onOkFunction;

        if (searchBox) {
          if ($(dropdown).hasClass("chosenSelect")) { // Check if Chosen is already initialized
            $(dropdown).trigger("chosen:updated"); // If so, just update
          } else {
              $(dropdown).chosen({
                  search_contains: true,
                  width: "100%"
              }).addClass("chosenSelect"); //Add a class to check if it has been initalized
          }
        }

        //convert the table to a bootstrap modal and show it to user.
        new bootstrap.Modal(dialogBox).show();
      }
    </script>

    <script>  //To add or remove rows from tables 
      async function addRow (source) {
        //Remove the search box from elements
        removeSearchBox();
        
        const rowToCopy = source.parentElement.parentElement;
        const tableData = rowToCopy.parentElement     //Fetch the table body
        
        const copy = rowToCopy.cloneNode(true);     //Create a copy of the row

        // Clear written text that the copy got from source row
        for (const child of copy.children) {
          //Get the type of element in row
          const tag = child.children[0].tagName;

          if (tag === 'INPUT') {
            //Set the value to blank if it is an input box
            child.children[0].value = '';
          } else if (tag === 'SELECT') {
            //deselect all options if it is a selection box
            child.children[0].selectedIndex = -1;
          }
        }
        
        //Insert the row after the clicked row
        tableData.insertBefore(copy, rowToCopy.nextSibling);
        
        //Change the serial numbers of the button for future usage
        const rows = tableData.children;
        for (let i=0;i<rows.length;i++) {
            rows[i].setAttribute("row",i);
        }
        
        addSearchBox();

        //Reset the sequence in any column named Sequence
        const sequences = tableData.querySelectorAll('[name*="Sequence"]')
        let previousSequence = 0;
        for (const sequence of sequences) {
            sequence.value = previousSequence+1;
            previousSequence = parseInt(sequence.value);
        }
      }

      async function removeRow (source, minRows = 0 ) {
        const tableData = source.parentElement.parentElement.parentElement;     //Fetch the table body   
        
        //Don't delete the row if it is the only one
        if (tableData.children.length < (minRows+3)) {
            alert("This is the last row. You cannot delete it!");
            return ;
        }

        const rowToRemove = source.parentElement.parentElement;    //Fetch the row out of the table
        const rowNum = parseInt(rowToRemove.getAttribute('row'));

        let dataFlag = false;               //Flag to check if there is data in the row

        const inputs = rowToRemove.querySelectorAll ("input");      //All the columns with inputs
        const selects = rowToRemove.querySelectorAll ("select");    //All the columns with selection options
        const combined = [...inputs, ...selects];                 //Combined inputs and selects

        for (const element of combined) {
            const deletable = element.parentElement.getAttribute("deletable") === "true";
            if (element.value && !deletable) {  
                dataFlag = true;                            //Set flag true if there is data in an element
                break;    
            }
        }
        
        if (dataFlag) {                 //Give warining if the dataflag is true.
            const removeFlag = confirm("There is data here. Are you sure you want to remove it?");
            if (!removeFlag) {          //User doesn't select OK.
                return ;
            }
        }

        rowToRemove.remove();           //Remove the row

        //Reset the serial in the buttons below the deleted row
        let rows = tableData.children;
        for (let i=rowNum;i<rows.length;i++) {
            rows[i].setAttribute("row",i);
        }

        //Reset the sequence in any column named Sequence
        const sequences = tableData.querySelectorAll('[name*="Sequence"]')
        let previousSequence = 0;
        for (const sequence of sequences) {
            sequence.value = previousSequence+1;
            previousSequence = parseInt(sequence.value);
        }
      }
    </script>

    <script>  //To add or remove search box
      function removeSearchBox() {
        //The keyword that is common in all search boxes
        const keyword = "chosen";
        //Get elements that contain the key word.
        const searchBoxNodes = document.querySelectorAll(`[${keyword}*='true']`);

        //Remove the search box from 
        for (const node of searchBoxNodes) {
            //Get the id of the seletion element
            const selectId = node.children[0].id;
            
            //Get the id of the selection box associated with selection element. It'll always be selectid_keyword
            const boxId = selectId+"_"+keyword;
    
            //Remove the selection box and destroy the script associated with it.
            document.getElementById(boxId).remove();
            $("#"+selectId).chosen("destroy"); 
        }
      }
      
      async function addSearchBox() {
        //The keyword that is common in all search boxes
        const keyword = "chosen";
        //Get elements that contain the key word.
        const searchBoxNodes = document.querySelectorAll(`[${keyword}*='true']`);

        //Add search box to all nodes
        for (const node of searchBoxNodes) {
          //Get the row number of the element
          const row = node.parentElement.getAttribute("row")
          //Get the drop down inside the element
          const dropdown = node.children[0];
          
          //Get the id of the drop down. To make it unique, we preset it in the format column_row.
          let id = dropdown.getAttribute("id");
          
          //Get the position of the last _ in the id.
          const trimAfter = id.lastIndexOf("_");

          //If _ exists and isn't at start of id, get the part after _.
          if (trimAfter > 2) {
            id = id.substring(0, trimAfter);
          }
          
          //Set the id to new row number and set it on the dropdown
          id = `${id}_${row}`;
          dropdown.setAttribute('id', id);

          //Apply the search box on the element, with the new ID.
          $("#"+id).chosen({
            search_contains: true,
            width: `93%`
          });
        }
      }
    </script>

    <script> //To handle warning for unsaved data
      //The if is in response to a bug, where it wouldn't define unsavedDataFlag while replacing html
      if (typeof unsavedDataFlag === 'undefined') {
        let unsavedDataFlag = false;
      }

      //Show warning to user if there is unsaved data.
      window.addEventListener('beforeunload', (event) => {
        if (unsavedDataFlag) {
          event.preventDefault(); // For some older browsers
          event.returnValue = ''; // For chrome or firefox
          return ''; // for Safari
        }
      });
    </script>
  </body>
</html>