{% extends 'marketing/base.html' %}

{% block title %}
    Customer Update
{% endblock title %}

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    <form method="POST" id="customerForm" autocomplete="off">  
        <div class="{{theme.border}}">
            <div class="grid grid-cols-2 {{theme.justify}} {{theme.align}}">
                <div class="flex w-full mt-4px-3 px-3 {{theme.align}}">
                    <label class="mr-2 whitespace-nowrap">Name:&nbsp; </label>
                    <input type="text" class="flex-grow {{theme.textInput}}" name="Name" value="{{customerData.Name}}" required>
                </div>
                <div class="flex w-full mt-4 px-3 {{theme.align}}">
                    <label class="mr-2 whitespace-nowrap">Country:&nbsp; </label>
                    <select id="id_Country" class="{{theme.dropdown}}" name="Country" required> </select>
                </div>
                <div class="flex w-full mt-4 px-3 {{theme.align}}">
                    <label class="mr-2 whitespace-nowrap">Website:&nbsp; </label>
                    <input type="url" class="flex-grow {{theme.textInput}}" name="Website" value="{{customerData.Website}}">
                </div>
                <div class="flex w-full mt-4 px-3 {{theme.align}}">
                    <label class="mr-2 whitespace-nowrap">Address:&nbsp; </label>
                    <input type="text" class="flex-grow {{theme.textInput}}" name="Address" value="{{customerData.Address}}">
                </div>
            </div>
    </form>
    <form method="POST" id="customerDetailForm" autocomplete="random-string">
            <div class="grid grid-cols-12 mt-4 px-3 {{theme.justify}} {{theme.align}} {{theme.border}} {{theme.tableHead}}" row="0">
                <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Contact Person
                    </div>
                </div>
                <div class="flex col-[3/4] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Designation
                    </div>
                </div>
                <div class="flex col-[4/7] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Phone Number
                    </div>
                </div>
                <div class="flex col-[7/11] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Email
                    </div>
                </div>
                <div class="flex col-[11/11] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Active?
                    </div>
                </div>
                <div class="flex col-[12/12] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            
            {% for data in contactData %}
                <div class="grid grid-cols-12 x-3 {{theme.justify}} {{theme.align}} {{theme.border}}" row="{{forloop.counter}}">                   
                    <div class="flex col-[1/3] px-1 {{theme.align}} {{theme.justify}}">
                        <input type="text" name="ContactDetailsId" value="{{data.ContactDetailsId}}" hidden>
                        <input type="text" name="ContactsId" value="{{data.ContactsId}}" hidden>
                        <input type="text" class="flex-grow {{theme.textInput}}" name="ContactPersonName" value="{{data.ContactPersonName}}">
                    </div>
                    <div class="flex col-[3/4] px-1 {{theme.align}} {{theme.justify}}">
                        <input type="text" class="flex-grow {{theme.textInput}}" name="ContactPersonDesignation" value="{{data.contactPersonDesignation}}">
                    </div>
                    <div class="flex col-[4/7] px-1 {{theme.align}} {{theme.justify}}">
                        <input type="text" class="flex-grow {{theme.textInput}}" name="ContactPersonNumber" value="{{data.contactPersonNumber}}">
                    </div>
                    <div class="flex col-[7/11] px-1 {{theme.align}} {{theme.justify}}">
                        <input type="email" class="flex-grow {{theme.textInput}}" name="ContactPersonEmail" value="{{data.contactPersonEmail}}">
                    </div>
                    <div class="flex col-[11/11] px-1 {{theme.align}} {{theme.justify}}">
                        <input type="checkbox" class="flex-grow {{theme.checkbox}}" name="IsActive" {% if data.IsActive is false %}{% else %}checked{% endif %}>
                    </div>
                    <div class="flex col-[12/12] space-x-1 {{theme.align}} {{theme.justify}}">
                        <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                            <span>+</span>
                        </button>
                        <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                            <span>-</span>
                        </button>
                    </div>
                </div>
            {% endfor %}  
        </div>
    </form>
    <button class="flex w-full mt-4 {{theme.buttonSecondary}} {{theme.justify}}" onclick="submitForms()">Save</button>

    <script>    //This code runs when the page is fully loaded
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Coutnries dropdown
            let response = await fetch('/options/countries');
            const countries = await response.json();
            await appendOptions('id_Country', countries, '{{customerData.Country}}');
            new TomSelect('#id_Country',{
                createOnBlur: true,
            });

            hideLoadingIcon();
        });
    </script>

    <script>    //To send data to server
        async function submitForms(){
            showLoadingIcon();

            const allForms = document.forms;

            const customerForm = allForms['customerForm']; 
            const contactForm = allForms['customerDetailForm'];

            const customerElements = customerForm.elements;

            let data = {};

            //Prepare the data for Customer Group
            let group = 'customer';
            for (const element of customerElements) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare data for Customer Details
            group = 'contact'
            let rows = contactForm.querySelectorAll('[row]');
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');

                let cols = row.children;
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    const inputElements = col.children;
                    
                    for (const inputElement of inputElements) {
                        name = inputElement.name + '_' + rowNum;;
                        let value;

                        if (inputElement.type === 'checkbox') {
                            value = inputElement.checked;
                        } else {
                            value = inputElement.value;
                        }
                        data[group+'_'+name] = value;
                    } 
                }
            }

            const response = await submitData(data);

            if (response.ok) {
                //To return to customers main.
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
            }

            hideLoadingIcon();
        }

        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            const data = JSON.stringify(obj);

            const response = await fetch('', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            return response;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>
{% endblock content %}