{% extends 'base.html' %}

{% block title %}
    Style Card Addition
{% endblock %} 

{% block content %}
<form method="POST">
  {% csrf_token %}

  <!-- Style Form -->
  <div class="{{theme.border}} p-6 rounded-2xl shadow-xl space-y-4 bg-inherit">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="{{theme.label}}">Code</label>
        {{ style.StyleCode }}
      </div>
      <div>
        <label class="{{theme.label}}">Name</label>
        {{ style.StyleName }}
      </div>
      <div>
        <label class="{{theme.label}}">Notes</label>
        {{ style.Notes }}
      </div>
      <div>
        <label class="{{theme.label}}">Customer</label>
        <select id="id_Customer" name="Customer" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600"></select>
      </div>
      <div>
        <label class="{{theme.label}}">Category</label>
        <select id="id_Category" name="Category" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600"></select>
      </div>
    </div>
    <div class="flex justify-end">
      <button id="submit" class="{{theme.buttonSecondary}}" type="button" onclick="submitForms()">Save</button>
    </div>
  </div>
</form>

<!-- Navigation Tabs -->
<div class="text-center my-6">
  <div class="btn-group">
    <button id="btn_variantTable" class="{{theme.tabButton}}" type="button" onclick="changeView('variantTable')">Variant</button>
    <button id="btn_routeTable" class="{{theme.tabButton}}" type="button" onclick="changeView('routeTable')">Route</button>
  </div>
</div>

<!-- Variant Table -->
<div id="variantTable">
  <form method="POST" id="variantForm">
    <div class="{{theme.tableHead}} grid grid-cols-11 font-semibold p-2 rounded text-white">
      <div class="col-span-5">Variant 1</div>
      <div class="col-span-5">Variant 2</div>
      <div class="col-span-1 text-center">Actions</div>
    </div>

    <div class="{{theme.tableBody}} grid grid-cols-11 gap-2 items-center mt-2 text-white">
      <div class="col-span-5">{{ var.Variant1 }}</div>
      <div class="col-span-5">{{ var.Variant2 }}</div>
      <div class="flex justify-center gap-2 col-span-1">
        <button class="{{theme.iconButtonSuccess}}" type="button" onclick="addRow(this)">+</button>
        <button class="{{theme.iconButtonError}}" type="button" onclick="removeRow(this)">-</button>
      </div>
    </div>
  </form>
</div>

<!-- Route Table -->
<div id="routeTable" style="display: none;">
  <form method="POST" id="routeForm">
    <div class="{{theme.tableHead}} grid grid-cols-11 font-semibold p-2 rounded text-white">
      <div class="col-span-5">Sequence</div>
      <div class="col-span-5">Stage</div>
      <div class="col-span-1 text-center">Actions</div>
    </div>

    <div class="{{theme.tableBody}} grid grid-cols-11 gap-2 items-center mt-2 text-white">
      <div class="col-span-5">{{ route.Sequence }}</div>
      <div class="col-span-5">
        <select class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600" id="id_RouteType_1" name="type"></select>
      </div>
      <div class="flex justify-center gap-2 col-span-1">
        <button class="{{theme.iconButtonSuccess}}" type="button" onclick="addRow(this)">+</button>
        <button class="{{theme.iconButtonError}}" type="button" onclick="removeRow(this)">-</button>
      </div>
    </div>
  </form>
</div>


<script>
  const tableIds = ['variantTable', 'routeTable'];

  function changeView(tableId) {
    for (let id of tableIds) {
      const table = document.getElementById(id);
      const button = document.getElementById('btn_' + id);

      if (tableId === id) {
        table.style.display = '';
        button.className = '{{theme.buttonSecondary}}'; // Highlight active
      } else {
        table.style.display = 'none';
        button.className = '{{theme.buttonSecondary}}'; // Default style
      }
    }
  }
</script>

<script>
  async function submitForms() {
    const styleForm = document.forms['styleForm']; 
    const variantForm = document.forms['variantForm'];
    const routeForm = document.forms['routeForm'];
    const style = styleForm?.elements;
    let data = {};

    if (style) {
      for (const element of style) {
        if (element.name) {
          data['style_' + element.name] = element.value;
        }   
      }
    }

    data = formToTable('variant', variantForm, data);
    data = formToTable('route', routeForm, data);

    await submitData(data);
  }

  async function submitData(obj) {
    const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    try {
      const response = await fetch('add', {
        method: 'POST',
        body: JSON.stringify(obj),
        headers: { "X-CSRFToken": csrf },
      });
      if (response.status === 200) {
        const styleName = await response.text();
        window.location.href = styleName + '/edit';
      } else {
        const errorMessage = await response.text();
        showMessage(errorMessage);
      }
    } catch (error) {
      alert(`Error occurred. Check with administrator. Error: ${error}`);
    }
  }

  function formToTable(group, form, data) {
    let rows = form.querySelectorAll('.row');
    rows = dropElements(rows);
    for (const row of rows) {
      let rowNum = row.getAttribute('row');
      let cols = row.children;
      cols = dropElements(cols, cols.length - 1, cols.length - 1);
      for (const col of cols) {
        const input = col.firstElementChild;
        if (input && input.name) {
          const name = input.name + '_' + rowNum;
          const value = input.value;
          data[group + '_' + name] = value;
        }
      }
    }
    return data;
  }

  function dropElements(obj, startFrom = 0, endAt = 0) {
    const arr = Object.values(obj);
    arr.splice(startFrom, endAt - startFrom + 1);
    return arr;
  }
</script>

<script>
  window.addEventListener('load', async () => {
    showLoadingIcon();

    const customerRes = await fetch('/options/customers');
    const customers = await customerRes.json();
    await appendOptions('id_Customer', customers);
    $("#id_Customer").chosen({ search_contains: true, width: "100%" });

    const categoryRes = await fetch('/options/categories');
    const categories = await categoryRes.json();
    await appendOptions('id_Category', categories);

    const stageRes = await fetch('/options/prodstages');
    const routeTypes = await stageRes.json();
    await appendOptions('id_RouteType_1', routeTypes);

    addSearchBox();
    hideLoadingIcon();
  });

  changeView('variantTable');
</script>
{% endblock %}
