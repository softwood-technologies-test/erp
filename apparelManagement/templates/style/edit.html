{% extends 'base.html' %}

{% block title %}
    Style Card Update
{% endblock %} 

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    
    <!-- The main style form-->
    <p>
        <form method="POST" id="styleForm">
            <div class="row g-3 bg-info {{theme.justify}} {{theme.align}} {{theme.border}}">
                <div class="col col-md-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Code:&nbsp; </label>
                    <input type="text" class="{{theme.textInput}}" value="{{style.StyleCode}}" name="StyleCode" readonly>
                </div>
                <div class="col col-md-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Name:&nbsp; </label>
                    <input type="text" class="{{theme.textInput}}" value="{{style.StyleName}}" name="StyleName">
                </div>
                <div class="col col-md-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Notes:&nbsp; </label>
                    <input type="text" class="{{theme.textInput}}" value="{{style.Notes}}" name="Notes">  
                </div>
                <div class="col col-md-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Customer:&nbsp; </label>
                    <select id="id_Customer" class="{{theme.dropdown}}" name="Customer"> </select>
                </div>
                <div class="col col-md-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Category:&nbsp; </label>
                    <select id="id_Category" class="{{theme.dropdown}}" name="Category"> </select>
                </div>
                <div class="col col-md-4 {{theme.align}} {{theme.textJustify}}">
                    <button id="submit" class="{{theme.buttonSecondary}}" onclick="submitForms()" type="button">          <!--Save Button-->
                        Save
                    </button>
                </div>
            </div>
        </form>
    </p>

    <!-- Buttons to go to each of a style's detail table-->
    <p>
        <div class="row g-3 {{theme.justify}} {{theme.align}} {{theme.textJustify}}">
            <div class = "col btn-group {{theme.justify}}">
                <button id="btn_variantTable" class="{{theme.buttonBasic}}" type="button" onclick="changeView('variantTable')">Variant</button>
                <button id="btn_consTable" class="{{theme.buttonBasic}}" type="button" onclick="changeView('consTable')">Consumption</button>
                <button id="btn_routeTable" class="{{theme.buttonBasic}}" type="button" onclick="changeView('routeTable')">Route</button>
            </div>
        </div>
    </p>
    <!-- Variants Table -->
    <div id="variantTable" name="variantTable" display="none">
        <div class="row {{theme.border}}">
            <div class="col-6">
                <form method="POST" id="variantForm" autocomplete="off">
                    <div class="row mt-0 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">
                        <div class="col-8">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Variant
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Actions
                            </div>
                        </div>
                    </div>
                    {% for data in var %}
                        <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="{{forloop.counter}}">
                            <div class="col-8">
                                <input type="text" class="{{theme.textInput}}" value="{{data.VariantCode}}" name="Variant"> 
                            </div>
                            <div class="col-4">
                                <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                                    <span>+</span>
                                </button>
                                <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                                    <span>-</span>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </form>
            </div>
            <div class="col-6">
                <div class="col-6">
                    <img src="" class="img-fluid">
                    There would be an image here.
                </div>
            </div>
        </div>
    </div>

    <!--Consumption Table-->
    <div id="consTable" name="consTable" display="none">
        <form method="POST" id="consumptionForm" autocomplete="off">
            <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">
                <div class="col col-md-3">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Inventory
                    </div>
                </div>
                <div class="col col-md-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Cons
                    </div>
                </div>
                <div class="col col-md-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Cons Unit
                    </div>
                </div>
                <div class="col col-md-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Type
                    </div>
                </div>
                <div class="col col-md-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Variants?
                    </div>
                </div>
                <div class="col col-md-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Size Details
                    </div>
                </div>
                <div class="col col-md-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            {% for data in cons %}
                <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="{{forloop.counter}}">
                    <div class="col-3" chosen="true">
                        <select class="{{theme.dropdown}}" id="id_InventoryCode_{{forloop.counter}}" name="InvCode">
                        </select>
                        <span class="material-symbols-outlined" onclick="openInvSearch(this)">search</span>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Consumption}}" name="Consumption">
                    </div>
                    <div class="col-2" chosen="true">
                        <select class="{{theme.dropdown}}" id="id_Unit_{{forloop.counter}}" name="Unit">
                        </select>
                    </div>
                    <div class="col-2">
                        <select class="{{theme.dropdown}}" id="id_ConsType_{{forloop.counter}}" name="type">
                        </select>
                    </div>
                    <div class="col-1">
                        <select class="{{theme.dropdown}}" id="id_HasVariant_{{forloop.counter}}" name="HasVariant">
                        </select>
                    </div>
                    <div class="col-2">
                        <input type="text" class="{{theme.textInput}}" value="{{data.SizeDetails}}" name="SizeDetails">
                    </div>
                    <div class="col-1">
                        <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                            <span>+</span>
                        </button>
                        <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                            <span>-</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </form>
    </div>

    <!--Production Route Table-->
    <div id="routeTable" name="routeTable">
        <div class="row {{theme.border}}">
            <div class="col-6">
                <form method="POST" id="routeForm">
                    <div class="row mt-1 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">
                        <div class="col-5">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Sequence
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Stage
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Actions
                            </div>
                        </div>
                    </div>
                    {% for data in route %}
                        <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="{{forloop.counter}}">
                            <div class="col-5" deletable="true">
                                <input type="number" class="{{theme.textInput}}" value="{{data.Sequence}}" name="Sequence">
                            </div>
                            <div class="col-5">
                                <select class="{{theme.dropdown}}" id="id_RouteType_{{forloop.counter}}" name="type">
                                </select>
                            </div>
                            <div class="col-2">
                                <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                                    <span>+</span>
                                </button>
                                <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                                    <span>-</span>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </form>
            </div>
            <div class="col-6">
                There would be an image here
            </div>
        </div>
    </div>

    <!--Inventory search dialog box-->
    <div class="modal fade" id="invSearchTable" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="{{theme.dialogBox}}">
            <div class="modal-content">
                <div class="{{theme.dialogBoxHeader}}">
                    <div class="{{theme.dialogBoxTitle}}" id="modalLabel">
                        Inventory Cards
                    </div>
                </div>
                <div class="{{theme.dialogBoxBody}}">
                    <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white">
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 1
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 2
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 3
                            </div>
                        </div>
                    </div>
                    <div class="row mt-1 {{theme.justify}} {{theme.textJustify}} {{theme.border}}" onkeyup="applySearch(this)">
                        <div hidden>
                            <input readonly>
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                    </div>
                    <div class="row mt-1 {{theme.justify}} {{theme.textJustify}} {{theme.border}} user-select-none" ondblclick="selectInv(this)">
                        <div hidden>
                            <span> ABCD</span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script> //To change view based on selected button
        const tableIds = ['variantTable', 'consTable','routeTable'];

        function changeView(tableId){
            let tables = [];

            for (let i=0;i<tableIds.length;i++) {
                tables[i] = document.getElementById (tableIds[i]);
                const button = document.getElementById('btn_'+tableIds[i]);
                if (tableId === tableIds[i]){
                    tables[i].style.display = "";
                    button.className = "{{theme.buttonSelected}}";
                } else {
                    tables[i].style.display = "none";
                    button.className = "{{theme.buttonBasic}}";
                }          
            }
        }
    </script>
    
    <script>    //This code runs when the page is fully loaded.
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Customer dropdown
            let response = await fetch('/options/customers');
            const customers = await response.json();
            await appendOptions('id_Customer', customers, "{{style.Customer}}");
            //Since this dropdown is not part of a table, we need manually apply search box
            $("#id_Customer").chosen({
                search_contains: true,
                width: "100%"
            });
            
            //Style Categories dropdown
            response = await fetch('/options/categories');
            const categories = await response.json();
            await appendOptions('id_Category', categories, "{{style.Category}}");
            
            //Consumptions data, that was passed as JSON from view
            const consumptionData = {{ consJson|safe }};
            //Inventory Cards dropdowns
            response = await fetch('/options/inventories?group=Direct');
            const inventories = await response.json();
            
            //Units dropdown
            response = await fetch('/options/units');
            const units = await response.json();

            //Consumption Types dropdowns
            response = await fetch('/options/constypes');
            const consTypes = await response.json();

            //Yes or No dropdown
            response = await fetch('/options/yesorno')
            const yesOrNo = await response.json();

            //Apply the relevant dropdowns on all rows of consumption
            for (const [index, data] of consumptionData.entries()) {
                await appendOptions(`id_InventoryCode_${index+1}`, inventories, data.InventoryCode);
                await appendOptions(`id_Unit_${index+1}`, units, data.Unit);
                await appendOptions(`id_ConsType_${index+1}`, consTypes, data.Type);
                await appendOptions(`id_HasVariant_${index+1}`, yesOrNo, data.HasVariant);
            }

            //Route data that was passed as JSON
            const routeData = {{ routeJson|safe}};

            //Production stages dropdown
            response = await fetch('/options/prodstages');
            const routeTypes = await response.json();
            
            //Apply the relevant dropdowns on all rows of route
            for (const [index, data] of routeData.entries()) {
                await appendOptions(`id_RouteType_${index+1}`, routeTypes, data.Stage);
            }

            //Apply search on dropdown where needed
            await addSearchBox();
            hideLoadingIcon();
            });

    </script>

    <script>   //To change the section based on the selected operation
        async function getOperationSection(source) {
            const operationObj = source.value;

            const response = await fetch('/options/section/'+operationObj);
            const section = await response.json();

            const sectionElement = source.parentElement.nextElementSibling.children[0];
            sectionElement.value = section;
        }
    </script>

    <script>    //To handle inventory search box
        async function openInvSearch(source) {
            //Filter out the inventories from server based on selected group
            const type = source.parentElement.parentElement.children[3].children[0].value;
            const invTableRowNum = source.parentElement.parentElement.getAttribute('row');
            
            let url = '/options/inventories'
            if (type == 'Fab') {
                url += `?group=Fabric`;
            } else if (type == '') {
                url += `?group=Direct`;
            } else {
                url += `?group=Trim`;
            }
            //Get the inventories from server
            const response = await fetch(url);
            const inventories = await response.json();
            //Remove the frist row, as that is blank
            inventories.shift();

            //Get the inventory search box template
            const searchTable = document.getElementById('invSearchTable');

            //Set the row number of inventory table in the dialogbox header to be used later on
            const searchTableHeader = searchTable.children[0].children[0].children[0];
            searchTableHeader.setAttribute('row',invTableRowNum);
            
            //Get all the rows
            const searchTableBody = searchTable.children[0].children[0].children[1];
            const rows= searchTableBody.children;
            const filterRow = searchTableBody.children[1];
            const templateRow = searchTableBody.children[2];

            //Remove any preivously added rows
            for (let i = searchTableBody.children.length - 1; i >= 2; i--) {
                rows[i].remove();
            }
            
            //Remove any values from the template row.
            for (const col of templateRow.children) {
                col.children[0].textContent = null;
            }
            //Set it's display style to nothing
            templateRow.style.display = '';

            //Create copies of the template for each inventory and append to the table
            for (const inventory of inventories) {
                const newRow = templateRow.cloneNode(true);

                newRow.children[0].children[0].textContent = inventory.value;
                newRow.children[1].children[0].textContent = inventory.text;
                newRow.children[2].children[0].textContent = inventory.text;
                newRow.children[3].children[0].textContent = inventory.text;

                searchTableBody.appendChild(newRow);
            }

            applySearch(filterRow);

            //convert the table to a bootstrap modal and show it to user.
            new bootstrap.Modal(searchTable).show();

            //Put cursor in the first column of the filter row
            searchTable.addEventListener('shown.bs.modal', () => {
                filterRow.children[1].children[0].focus();
            });            
        }

        async function selectInv(source) {            
            const selectedCode = source.children[0].children[0].textContent;

            const consTableRowNum = parseInt(source.parentElement.parentElement.children[0].getAttribute('row'));

            const consTableRow = document.getElementById('consTable').children[0].children[consTableRowNum];

            const invCodeBox = consTableRow.children[0].children[0];
            
            invCodeBox.value = selectedCode;
            
            const id = invCodeBox.id;
            $("#"+id).trigger('chosen:updated');

            $('#invSearchTable').modal('hide');
        }

        function applySearch(source) {
            const columns = source.children;
            
            // Get all the search terms
            let searchTerms = [];
            for (const column of columns) {
                //Convert search term to lower case and append to the array
                searchTerms.push(column.children[0].value.toLowerCase());
            }

            const searchTableBody = source.parentElement;
            //Get all rows except first 2
            const rows = searchTableBody.querySelectorAll('.row:not(:nth-child(-n+2))');
            
            for (const row of rows) {
                //Make an array of all true values, with same length as number of search terms
                let match = Array(searchTerms.length).fill(true);
                const cols = row.children;

                for (let i=0; i<searchTerms.length; i++) {
                    const cellValue = cols[i].children[0].textContent.toLowerCase();

                    //set corresponding value of match to true if it matches, otherwise false
                    match[i] = cellValue.includes(searchTerms[i]);
                }
                //set combined flag to true, if all values in match are true
                const combinedFlag = match.every(flag => flag);

                //Show row if combined flag is true, otherwise false.
                row.style.display = combinedFlag ? '' : 'none';
            }
        }
    </script>

    <script> //To send data to server
        async function submitForms() {
            showLoadingIcon();
            const allForms = document.forms;

            const styleForm = allForms['styleForm']; 
            const variantForm = allForms['variantForm'];
            const consumptionForm = allForms['consumptionForm'];
            const routeForm = allForms['routeForm'];
            
            const style = styleForm.elements;

            let data = {};
             
            //Prepare the data for Style Group
            let group = 'style';
            for (const element of style) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare the data for each Group
            data = formToTable('variant', variantForm, data);
            data = formToTable('cosumption', consumptionForm, data);
            data = formToTable('route', routeForm, data);

            const tableIds = ['variantTable', 'consTable','routeTable'];

            let selectedTable = null
            for (const id of tableIds) {
                const table = document.getElementById(id);
                const tableDisplay = table.style.display;
                if (tableDisplay != 'none') {
                    selectedTable = id;
                }
            }
            data['style_SelectedTable'] = selectedTable;
            
            const response = await submitData(data)

            hideLoadingIcon();
            
            if (response.ok) {
                const selectedTable = await response.text();
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
            }
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);
            
            //console.log (csrf);
            const response = await fetch('', {
              method: 'POST',
              body: data,
              headers: { "X-CSRFToken": csrf},
            });

            return response;
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('.row');
            //Remove unnecesary rows
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;                    
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>

    <script> //To run when page loads. It should be at the end of the page.         
        changeView ('consTable');
    </script>
{% endblock %} 