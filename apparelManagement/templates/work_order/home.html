{% extends 'base.html' %}

{% block title %}
    Work Orders
{% endblock %}

{% block content %}
<div class="{{ theme.pageBody }} {{ theme.border }} p-4">

  <!-- Filters and Actions -->
  <div class="row mb-4">
    <div class="col-md-4">
      <form action="{% url 'WOs' %}" method="get">
        <label for="customerFilter" class="form-label fw-bold">Select Customer</label>
        <select id="customerFilter" name="customerFilter" onchange="this.form.submit()" class="{{ theme.dropdown }}">
          <option value="">All Customers</option>
        </select>
        <input type="hidden" name="search_term" value="{{ searchTerm }}">
      </form>
    </div>

    <div class="col-md-8 text-end d-flex justify-content-end align-items-end gap-2 mt-4 mt-md-0">
      <a class="{{ theme.buttonSecondary }}" href="/workorder/add" target="_blank">Add Order</a>
      <a id="copyOrderButton" class="{{ theme.buttonSecondary }}" target="_blank">Copy Order</a>
      <a id="editOrderButton" class="{{ theme.buttonSecondary }}" target="_blank">Edit Order</a>
      <a id="deleteOrderButton" class="{{ theme.buttonSecondary }}">Delete Order</a>
    </div>
  </div>

  <!-- Search -->
  <form action="{% url 'WOs' %}" method="get" class="row mb-4">
    <div class="col-md-10">
      <label for="search_term" class="form-label fw-bold">Search Orders</label>
      <input type="text" name="search_term" class="{{ theme.textInput }}" placeholder="Search by order number, style, or customer" value="{{ searchTerm }}">
      <input type="hidden" name="customerFilter" value="{{ selectedCustomer }}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="{{ theme.buttonBasic }} w-100">Search</button>
    </div>
  </form>

  <!-- Table -->
  <div class="table-responsive">
    <table class="{{ theme.table }}">
      <thead class="{{ theme.tableHead }}">
        <tr>
          <th>Select</th>
          <th>Work Order</th>
          <th>Style</th>
          <th>Customer</th>
          <th>Quantity</th>
          <th>Ex-Factory</th>
          <th>Merchandiser</th>
        </tr>
      </thead>
      <tbody id="tableData">
        {% for data in order %}
          <tr>
            <td><input type="radio" name="item_checkbox" class="{{ theme.checkbox }}"></td>
            <td>{{ data.OrderNumber }}</td>
            <td>{{ data.StyleCode_id }}</td>
            <td>{{ data.Customer_id }}</td>
            <td>{{ data.Quantity }}</td>
            <td>{{ data.DeliveryDate }}</td>
            <td>{{ data.Merchandiser }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <div>
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&customerFilter={{ selectedCustomer }}&search_term={{ searchTerm }}" class="{{ theme.linkPaginaton }}">Previous</a>
      {% else %}
        <span class="text-muted">Previous</span>
      {% endif %}

      <span class="mx-2">|</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&customerFilter={{ selectedCustomer }}&search_term={{ searchTerm }}" class="{{ theme.linkPaginaton }}">Next</a>
      {% else %}
        <span class="text-muted">Next</span>
      {% endif %}
    </div>

    <form method="get" class="d-flex align-items-center gap-2">
      <label class="form-label mb-0">Page:</label>
      <select name="page" onchange="this.form.submit()" class="{{ theme.dropdown }}">
        {% for page_num in page_obj.paginator.page_range %}
          <option value="{{ page_num }}" {% if page_num == page_obj.number %}selected{% endif %}>{{ page_num }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="customerFilter" value="{{ selectedCustomer }}">
      <input type="hidden" name="search_term" value="{{ searchTerm }}">
    </form>
  </div>
</div>

<!-- JS for row selection -->
<script>
  document.querySelector("#tableData").addEventListener("click", (e) => {
    if (e.target.name === "item_checkbox") {
      const row = e.target.closest("tr");
      const orderNum = row.children[1].innerText.trim();
      document.getElementById("copyOrderButton").href = `/workorder/${orderNum}/copy`;
      document.getElementById("editOrderButton").href = `/workorder/${orderNum}/edit`;
      document.getElementById("deleteOrderButton").href = `/workorder/${orderNum}/delete`;
    }
  });

  // Load customers
  window.addEventListener('load', async () => {
    const res = await fetch('/options/customers');
    const data = await res.json();
    await appendOptions('customerFilter', data, '{{ selectedCustomer }}');
    $("#customerFilter").chosen({ search_contains: true, width: "100%" });
  });
</script>
{% endblock %}
