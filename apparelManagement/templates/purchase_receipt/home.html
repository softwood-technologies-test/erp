{% extends 'base.html' %}

{% block title %}
  Inventory Receipts
{% endblock %}

{% block content %}
<div class="{{theme.border}} p-6 rounded-xl shadow-md bg-inherit space-y-6">

  <!-- FILTERS & ACTION BUTTONS -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

    <!-- Supplier Filter -->
    <form action="{% url 'purchaseRec' %}" method="get" class="w-full md:w-auto">
      <label class="block text-white font-semibold mb-1">Filter by Supplier</label>
      <select id="supplierFilter" name="supplierFilter" onchange="this.form.submit()" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600">
        <option value="">---------</option>
      </select>
      <input type="hidden" name="searchTerm" value="{{ searchTerm }}">
      <input type="hidden" name="recFilter" value="{{ selectedRec }}">
    </form>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3">
      <a href="/purchasereceipt/add" class="{{theme.buttonSecondary}} " target="_blank">Add Receipt</a>
      <a id="copyReceiptButton" class="{{theme.buttonSecondary}} " target="_blank">Copy Receipt</a>
      <a id="editReceiptButton" class="{{theme.buttonSecondary}} " target="_blank">Edit Receipt</a>
      <a id="deleteReceiptButton" class="{{theme.buttonSecondary}} " target="_blank">Delete Receipt</a>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <form action="{% url 'purchaseRec' %}" method="get" class="flex flex-col md:flex-row gap-3 md:items-center">
    <div class="md:w-2/12">
      <input type="number" name="recFilter" placeholder="Receipt Number" value="{{selectedRec}}"
        class="{{theme.textInput}} w-full text-white bg-gray-800 border border-gray-600 rounded-md p-2" />
    </div>
    <div class="flex-1">
      <input type="text" name="searchTerm" placeholder="Search Receipts" value="{{searchTerm}}"
        class="{{theme.textInput}} w-full text-white bg-gray-800 border border-gray-600 rounded-md p-2" />
      <input type="hidden" name="supplierFilter" value="{{ selectedSupplier }}">
    </div>
    <div class="md:w-32">
      <button type="submit" class="{{theme.buttonSecondary}} ">Search</button>
    </div>
  </form>

  <!-- TABLE -->
  <div id="purchaseOrderTable" class="overflow-x-auto mt-4">
    <table class="{{theme.table}} w-full table-fixed border border-gray-600 text-left text-sm md:text-base text-white">
      <thead class="{{theme.tableHead}} bg-gray-900 text-white font-semibold">
        <tr>
          <th class="p-2 w-1/12">Select</th>
          <th class="p-2 w-2/12">Receipt Number</th>
          <th class="p-2 w-2/12">PO Number</th>
          <th class="p-2 w-2/12">Receipt Date</th>
          <th class="p-2 w-2/12">Supplier</th>
          <th class="p-2 w-2/12">Inventory (Top 3)</th>
          <th class="p-2 w-2/12">Work Order (Top 3)</th>
        </tr>
      </thead>
      <tbody id="tableData" class="{{theme.tableBody}} bg-gray-800 text-white">
        {% for data in receipt %}
        <tr class="border-t border-gray-700 hover:bg-gray-700">
          <td class="p-2"><input type="radio" name="item_checkbox" class="accent-indigo-500"></td>
          <td class="p-2 receipt font-mono">{{ data.ReceiptNumber }}</td>
          <td class="p-2">{{ data.PONumber }}</td>
          <td class="p-2">{{ data.ReceiptDate }}</td>
          <td class="p-2">{{ data.Supplier }}</td>
          <td class="p-2">{{ data.Name }}</td>
          <td class="p-2">{{ data.WorkOrder }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- SCRIPT -->
  <script>
    // Update buttons on row selection
    $("#tableData").on("click", "input[type='radio']", function () {
      const selectedCode = $(this).closest("tr").find("td.receipt").text().trim();
      $("#copyReceiptButton").attr("href", "/purchasereceipt/" + selectedCode + "/copy");
      $("#editReceiptButton").attr("href", "/purchasereceipt/" + selectedCode + "/edit");
      $("#deleteReceiptButton").attr("href", "/purchasereceipt/" + selectedCode + "/delete");
    });

    // Populate supplier dropdown on load
    window.addEventListener('load', async () => {
      let response = await fetch('/options/suppliers');
      const suppliers = await response.json();
      await appendOptions('supplierFilter', suppliers, '{{selectedSupplier}}');
      $("#supplierFilter").chosen({
        search_contains: true,
        width: "100%"
      });
    });
  </script>
</div>
{% endblock %}
