{% extends 'base.html' %}

{% block title %}
    Purchase Receipt Addition
{% endblock %} 

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->

    <!-- The main Order form-->
    <p>
        <form method="POST" id="receiptForm" autocomplete="off">
            <div class="row g-3 bg-info {{theme.justify}} {{theme.align}} {{theme.border}}">
                <div class="col-2 d-flex {{theme.align}} {{theme.justify}}" onchange="getPO(this)">
                    <label>PO:&nbsp; </label>
                    <select id="id_PO" class="{{theme.dropdown}}" name="PONumber"> </select>
                </div>
                <div class="col-2 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Invoice:&nbsp; </label>
                    {{receipt.Invoice}}
                </div>
                <div class="col-2 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Vehicle:&nbsp; </label>
                    {{receipt.Vehicle}}
                </div>
                <div class="col-2 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Bilty#:&nbsp; </label>
                    {{receipt.Bilty}}
                </div>
                <div class="col-2 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Amount:&nbsp; </label>
                    {{receipt.BiltyValue}}
                </div>
                <div class="col-1 {{theme.align}} {{theme.textJustify}}">
                    <button id="submit" class="{{theme.buttonSecondary}}" onclick="submitForms()" type="button">          <!--Save Button-->
                        Save
                    </button>
                </div>
            </div>
        </form>
    </p>
    <!--Inventory Table-->
    <div id="inventoryTable" name="invTable">
        <div class="row">
            <div class="col-8 {{theme.border}}">
                <form method="POST" id="inventoryForm" autocomplete="off">
                    <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">    
                        <div class="col-5">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Inventory Code
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Variant
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Quantity
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Actions
                            </div>
                        </div>
                    </div>
                    
                    {% for data in inventory %}
                        <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="{{forloop.counter}}">
                            <div class="col-5">
                                <input type="text" class="{{theme.textInput}}" value="{{data.Inventory}}" name="InvCode" hidden>
                                <input type="text" class="{{theme.textInput}}" value="{{data.Name}}" name="Name" readonly>
                            </div>
                            <div class="col-2">
                                <input type="text" class="{{theme.textInput}}" value="{{data.Variant}}" name="Variant" readonly>
                            </div>
                            <div class="col-3">
                                <input type="number" class="{{theme.textInput}}" value="{{data.Quantity}}" name="Quantity">
                            </div>
                            <div class="col-2">
                                <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                                    <span>+</span>
                                </button>
                                <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                                    <span>-</span>
                                </button>
                            </div>
                        </div>    
                    {% endfor %} 
                </form>
            </div>
            <div class="col-4 {{theme.border}}">
                <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white">
                    <div class="col">
                        <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                            Context Box
                        </div>
                    </div>
                </div>
            </div>
        </div>     
    </div>

    <script> //To run after page loads.
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Purchase Order dropdowns
            response = await fetch('/options/purchaseorders/open');
            const pos = await response.json();
            await appendOptions('id_PO', pos, '{{poNumber}}');
            $("#id_PO").chosen({
                search_contains: true,
                width: "100%"
            });

            addSearchBox();

            delete response;

            hideLoadingIcon();
        });
    </script>

    <script> //To send data to server
        function submitForms() {
            const allForms = document.forms;

            const receiptForm = allForms['receiptForm']; 
            const inventoryForm = allForms['inventoryForm'];

            const poNumber = parseInt(document.getElementById('id_PO').value);
            if (!poNumber) {
                showMessage('PO Number is mandatory');
                return;
            }
            
            
            const receipt = receiptForm.elements;

            let data = {};
             
            //Prepare the data for Style Group
            let group = 'receipt';
            for (const element of receipt) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare the data for inventory Group
            data = formToTable('inventory', inventoryForm, data);
            
            submitData(data)
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);
            
            //console.log (csrf);
            const response = await fetch('', {
              method: 'POST',
              body: data,
              headers: { "X-CSRFToken": csrf},
            });

            if (response.status == 200) {
                const recNumber = await response.text();
                window.location.href = recNumber+'/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
            
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('.row');
            //Remove unnecesary rows
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>

    <script> //To get the data for the PO
        async function getPO (source) {
            const poNumber = source.children[1].value;
            const currentUrl = new URL(window.location.href);

            currentUrl.search = '';
            currentUrl.searchParams.append('poNumber',poNumber);

            window.location.href = currentUrl.href;
        }
    </script>

    <script> //To run at the start of the page. This should be at the end of the page.
    </script>
{% endblock %}