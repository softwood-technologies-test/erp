{% extends 'base.html' %}

{% block title %}
    Purchase Receipt Addition
{% endblock %} 

{% block content %}
<form method="POST" id="receiptForm" autocomplete="off" class="space-y-6">
    {% csrf_token %}

    <!-- MAIN RECEIPT FORM -->
    <div class="p-6 rounded-xl shadow-md {{theme.border}} space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
            <!-- PO Dropdown -->
            <div class="col-span-1 md:col-span-1" onchange="getPO(this)">
                <label class="block font-semibold text-white-800 mb-1">PO</label>
                <select id="id_PO" name="PONumber" class="{{theme.dropdown}} w-full"></select>
            </div>

            <!-- Invoice -->
            <div class="col-span-1 md:col-span-1">
                <label class="block font-semibold text-white-800 mb-1">Invoice</label>
                {{receipt.Invoice}}
            </div>

            <!-- Vehicle -->
            <div class="col-span-1 md:col-span-1">
                <label class="block font-semibold text-white-800 mb-1">Vehicle</label>
                {{receipt.Vehicle}}
            </div>

            <!-- Bilty -->
            <div class="col-span-1 md:col-span-1">
                <label class="block font-semibold text-white-800 mb-1">Bilty#</label>
                {{receipt.Bilty}}
            </div>

            <!-- Amount -->
            <div class="col-span-1 md:col-span-1">
                <label class="block font-semibold text-white-800 mb-1">Amount</label>
                {{receipt.BiltyValue}}
            </div>

            <!-- Save Button -->
            <div class="col-span-1 md:col-span-1 flex justify-end items-end">
                <button id="submit" class="{{theme.buttonSecondary}} w-full" type="button" onclick="submitForms()">Save</button>
            </div>
        </div>
    </div>
</form>

<!-- INVENTORY TABLE -->
<div class="mt-6 space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Inventory Form -->
        <div class="md:col-span-2 {{theme.border}} p-4 rounded-xl shadow-md">
            <form method="POST" id="inventoryForm" autocomplete="off" class="space-y-2">
                {% csrf_token %}

                <!-- Table Headers -->
                <div class="grid grid-cols-12 gap-2 bg-gray-800 text-white font-semibold text-sm p-2 rounded">
                    <div class="col-span-5">Inventory Code</div>
                    <div class="col-span-2">Variant</div>
                    <div class="col-span-3">Quantity</div>
                    <div class="col-span-2">Actions</div>
                </div>

                <!-- Inventory Rows -->
                {% for data in inventory %}
                <div class="grid grid-cols-12 gap-2 items-center p-2 bg-gray-100 rounded">
                    <div class="col-span-5">
                        <input type="text" name="InvCode" value="{{data.Inventory}}" hidden>
                        <input type="text" class="{{theme.textInput}} w-full" name="Name" value="{{data.Name}}" readonly>
                    </div>
                    <div class="col-span-2">
                        <input type="text" class="{{theme.textInput}} w-full" name="Variant" value="{{data.Variant}}" readonly>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="{{theme.textInput}} w-full" name="Quantity" value="{{data.Quantity}}">
                    </div>
                    <div class="col-span-2 flex gap-1">
                        <button type="button" class="{{theme.plusButton}}" onclick="addRow(this)">+</button>
                        <button type="button" class="{{theme.minusButton}}" onclick="removeRow(this)">-</button>
                    </div>
                </div>
                {% endfor %}
            </form>
        </div>

        <!-- Context Box -->
        <div class="{{theme.border}} p-4 rounded-xl shadow-md">
            <div class="bg-gray-800 text-white text-sm font-semibold p-2 rounded">
                Context Box
            </div>
            <!-- Add any extra context content here -->
        </div>
    </div>
</div>



    <script> //To run after page loads.
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Purchase Order dropdowns
            response = await fetch('/options/purchaseorders/open');
            const pos = await response.json();
            await appendOptions('id_PO', pos, '{{poNumber}}');
            $("#id_PO").chosen({
                search_contains: true,
                width: "100%"
            });

            addSearchBox();

            delete response;

            hideLoadingIcon();
        });
    </script>

    <script> //To send data to server
        function submitForms() {
            const allForms = document.forms;

            const receiptForm = allForms['receiptForm']; 
            const inventoryForm = allForms['inventoryForm'];

            const poNumber = parseInt(document.getElementById('id_PO').value);
            if (!poNumber) {
                showMessage('PO Number is mandatory');
                return;
            }
            
            
            const receipt = receiptForm.elements;

            let data = {};
             
            //Prepare the data for Style Group
            let group = 'receipt';
            for (const element of receipt) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare the data for inventory Group
            data = formToTable('inventory', inventoryForm, data);
            
            submitData(data)
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);
            
            //console.log (csrf);
            const response = await fetch('', {
              method: 'POST',
              body: data,
              headers: { "X-CSRFToken": csrf},
            });

            if (response.status == 200) {
                const recNumber = await response.text();
                window.location.href = recNumber+'/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
            
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('.row');
            //Remove unnecesary rows
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>

    <script> //To get the data for the PO
        async function getPO (source) {
            const poNumber = source.children[1].value;
            const currentUrl = new URL(window.location.href);

            currentUrl.search = '';
            currentUrl.searchParams.append('poNumber',poNumber);

            window.location.href = currentUrl.href;
        }
    </script>

    <script> //To run at the start of the page. This should be at the end of the page.
    </script>
{% endblock %}