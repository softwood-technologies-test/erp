{% extends 'base.html' %}

{% block title %}
    Purchase Demand Addition
{% endblock %} 

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->

    <!-- The main Demand form-->
    <p>
        <form method="POST" id="demandForm" autocomplete="off">
            <div class="row g-3 bg-info {{theme.justify}} {{theme.align}} {{theme.border}}">
                <div class="col d-flex {{theme.align}} {{theme.justify}}">
                    <label>Department:&nbsp; </label>
                    <select id="id_Department" class="{{theme.dropdown}}" name="Department"> </select>
                </div>
                <div class="col-4 d-flex {{theme.align}} {{theme.justify}}">
                    <label>Name:&nbsp; </label>
                    {{demand.Demandee}}
                </div>
                <div class="col-1 {{theme.align}} {{theme.textJustify}}">
                    <button id="submit" class="{{theme.buttonSecondary}}" onclick="submitForms()" type="button">          <!--Save Button-->
                        Submit
                    </button>
                </div>
            </div>
        </form>
    </p>
    <!--Inventory Table-->
    <div id="inventoryTable" name="invTable">
        <form method="POST" id="inventoryForm" autocomplete="off">
            <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">    
                <div class="col-3">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Inventory
                    </div>
                </div>
                <div class="col-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Variant
                    </div>
                </div>
                <div class="col-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Quantity
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Price
                    </div>
                </div>
                <div class="col-2">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Currency
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Forex
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="1">
                <div class="col-3" chosen="true">
                    <select class="{{theme.dropdown}}" id="id_InventoryCode_1" name="InvCode"></select>
                    <span class="material-symbols-outlined" onclick="openInvSearch(this)">search</span>
                </div>
                <div class="col-2">
                    {{inventory.Variant}}
                </div>
                <div class="col-2">
                    {{inventory.Quantity}}
                </div>
                <div class="col-1">
                    {{inventory.Price}}
                </div>
                <div class="col-2">
                    <select class="{{theme.dropdown}}" id="id_Currency_1" name="Currency"></select>
                </div>
                <div class="col-1">
                    {{inventory.Forex}}
                </div>
                <div class="col-1">
                    <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                        <span>+</span>
                    </button>
                    <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                        <span>-</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!--Inventory search dialog box-->
    <div class="modal fade" id="invSearchTable" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="{{theme.dialogBox}}">
            <div class="modal-content">
                <div class="{{theme.dialogBoxHeader}}">
                    <div class="{{theme.dialogBoxTitle}}" id="modalLabel">
                        Inventory Cards
                    </div>
                </div>
                <div class="{{theme.dialogBoxBody}}">
                    <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white">
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 1
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 2
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                                Filter 3
                            </div>
                        </div>
                    </div>
                    <div class="row mt-1 {{theme.justify}} {{theme.textJustify}} {{theme.border}}" onkeyup="applySearch(this)">
                        <div hidden>
                            <input readonly>
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                        <div class="col-4">
                            <input type="text" class="{{theme.textInput}}">
                        </div>
                    </div>
                    <div class="row mt-1 {{theme.justify}} {{theme.textJustify}} {{theme.border}} user-select-none" ondblclick="selectInv(this)">
                        <div hidden>
                            <span> ABCD</span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                        <div class="col-4">
                            <span class="{{theme.textInput}}"> </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script> //To run after page loads.
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Purchase Order dropdowns
            response = await fetch('/options/departments');
            const departments = await response.json();
            await appendOptions('id_Department', departments);
            $("#id_Department").chosen({
                search_contains: true,
                width: "100%"
            });

            //Inventory Cards dropdowns
            response = await fetch('/options/inventories?group=Indirect');
            const inventories = await response.json();
            await appendOptions('id_InventoryCode_1', inventories);

            response = await fetch('/options/currencies');
            const currencies = await response.json();
            await appendOptions('id_Currency_1', currencies,'PKR');

            addSearchBox();

            delete response;

            hideLoadingIcon();
        });
    </script>

    <script>    //To handle inventory search box
        async function openInvSearch(source) {
            const invTableRowNum = source.parentElement.parentElement.getAttribute('row');
            
            let url = '/options/inventories?group=Indirect'
            //Get the inventories from server
            const response = await fetch(url);
            const inventories = await response.json();
            //Remove the frist row, as that is blank
            inventories.shift();

            //Get the inventory search box template
            const searchTable = document.getElementById('invSearchTable');

            //Set the row number of inventory table in the dialogbox header to be used later on
            const searchTableHeader = searchTable.children[0].children[0].children[0];
            searchTableHeader.setAttribute('row',invTableRowNum);
            
            //Get all the rows
            const searchTableBody = searchTable.children[0].children[0].children[1];
            const rows= searchTableBody.children;
            const filterRow = searchTableBody.children[1];
            const templateRow = searchTableBody.children[2];

            //Remove any preivously added rows
            for (let i = searchTableBody.children.length - 1; i >= 2; i--) {
                rows[i].remove();
            }
            
            //Remove any values from the template row.
            for (const col of templateRow.children) {
                col.children[0].textContent = null;
            }
            //Set it's display style to nothing
            templateRow.style.display = '';

            //Create copies of the template for each inventory and append to the table
            for (const inventory of inventories) {
                const newRow = templateRow.cloneNode(true);

                newRow.children[0].children[0].textContent = inventory.value;
                newRow.children[1].children[0].textContent = inventory.text;
                newRow.children[2].children[0].textContent = inventory.text;
                newRow.children[3].children[0].textContent = inventory.text;

                searchTableBody.appendChild(newRow);
            }

            applySearch(filterRow);

            //convert the table to a bootstrap modal and show it to user.
            new bootstrap.Modal(searchTable).show();

            //Put cursor in the first column of the filter row
            searchTable.addEventListener('shown.bs.modal', () => {
                filterRow.children[1].children[0].focus();
            });            
        }

        async function selectInv(source) {            
            const selectedCode = source.children[0].children[0].textContent;

            const invTableRowNum = parseInt(source.parentElement.parentElement.children[0].getAttribute('row'));

            const invTableRow = document.getElementById('inventoryTable').children[0].children[invTableRowNum];

            const invCodeBox = invTableRow.children[0].children[0];
            
            invCodeBox.value = selectedCode;
            
            const id = invCodeBox.id;
            $("#"+id).trigger('chosen:updated');

            $('#invSearchTable').modal('hide');
        }


        function applySearch(source) {
            const columns = source.children;
            
            // Get all the search terms
            let searchTerms = [];
            for (const column of columns) {
                //Convert search term to lower case and append to the array
                searchTerms.push(column.children[0].value.toLowerCase());
            }

            const searchTableBody = source.parentElement;
            //Get all rows except first 2
            const rows = searchTableBody.querySelectorAll('.row:not(:nth-child(-n+2))');
            
            for (const row of rows) {
                //Make an array of all true values, with same length as number of search terms
                let match = Array(searchTerms.length).fill(true);
                const cols = row.children;

                for (let i=0; i<searchTerms.length; i++) {
                    const cellValue = cols[i].children[0].textContent.toLowerCase();

                    //set corresponding value of match to true if it matches, otherwise false
                    match[i] = cellValue.includes(searchTerms[i]);
                }
                //set combined flag to true, if all values in match are true
                const combinedFlag = match.every(flag => flag);

                //Show row if combined flag is true, otherwise false.
                row.style.display = combinedFlag ? '' : 'none';
            }
        }
    </script>

    <script> //To send data to server
        function submitForms() {
            const allForms = document.forms;

            const demandForm = allForms['demandForm']; 
            const inventoryForm = allForms['inventoryForm'];            
            
            const demand = demandForm.elements;

            let data = {};
             
            //Prepare the data for Style Group
            let group = 'demand';
            for (const element of demand) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare the data for inventory Group
            data = formToTable('inventory', inventoryForm, data);
            
            submitData(data)
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);
            
            //console.log (csrf);
            const response = await fetch('', {
              method: 'POST',
              body: data,
              headers: { "X-CSRFToken": csrf},
            });

            if (response.status == 200) {
                const demandNumber = await response.text();
                window.location.href = demandNumber+'/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
            
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('.row');
            //Remove unnecesary rows
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>
{% endblock %}