{% extends 'base.html' %}

{% block title %}
    Purchase Demands
{% endblock %}

{% block content %}
    <div class="{{theme.border}} p-6 rounded-xl shadow-md bg-inherit space-y-6">
        {% csrf_token %}
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

            <!-- Department Filter Dropdown -->
            <div class="flex-1 md:w-3/12">
                <form action="{% url 'purchaseDemand' %}" method="get">
                    <label for="departmentFilter" class="block text-white font-semibold mb-1">Department</label>
                    <select id="departmentFilter" name="departmentFilter" onchange="this.form.submit()" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600">
                        <option value=""> --------- </option>
                        <!-- Dynamic department options go here -->
                    </select>
                    <input type="hidden" name="searchTerm" value="{{ searchTerm }}">
                    <input type="hidden" name="poNumber" value="{{ selectedPO }}">
                </form>
            </div>

            <!-- Action Buttons (Aligned Right) -->
            <div class="flex gap-3 justify-end md:w-9/12">
                <a class="btn {{theme.buttonSecondary}} mb-2" href="/purchasedemand/add" role="button" target="_blank">Add New</a>
                <a id="copyDemandButton" class="btn {{theme.buttonSecondary}} mb-2" role="button">Copy</a>
                <a id="editDemandButton" class="btn {{theme.buttonSecondary}} mb-2" role="button" target="_blank">Edit</a>
                <a id="deleteDemandButton" class="btn {{theme.buttonSecondary}} mb-2" role="button">Delete</a>
                <a id="approveDemandButton" class="btn {{theme.buttonSecondary}} mb-2" role="button">Approve</a>
            </div>
        </div>

        <!-- Search and Status Filters (Styled and Aligned Properly) -->
        <div class="flex flex-col md:flex-row gap-4 md:items-center">
            <div class="md:w-3/12">
                <form action="{% url 'purchaseDemand' %}" method="get">
                    <label for="demandFilter" class="block text-white font-semibold mb-1">Demand Number</label>
                    <input type="number" class="form-control {{theme.textInput}} w-full text-white bg-gray-800 border-gray-600" name="demandFilter" placeholder="Demand Number" value="{{selectedDemand}}">
                </form>
            </div>

            <div class="md:w-3/12">
                <label for="statusFilter" class="block text-white font-semibold mb-1">Status</label>
                <select name="statusFilter" onchange="this.form.submit()" class="form-select {{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600">
                    <option value="OnApp" {% if selectedStatus == "OnApp" %}selected{% endif %}>Pending Approval</option>
                    <option value="OnPO" {% if selectedStatus == "OnPO" %}selected{% endif %}>Pending PO</option>
                    <option value="Rej" {% if selectedStatus == "Rej" %}selected{% endif %}>Rejected</option>
                    <option value="Close" {% if selectedStatus == "Close" %}selected{% endif %}>Closed</option>
                </select>
            </div>

            <div class="md:w-4/12">
                <label for="searchTerm" class="block text-white font-semibold mb-1">Search Demands</label>
                <input type="text" class="form-control {{theme.textInput}} w-full text-white bg-gray-800 border-gray-600" name="searchTerm" placeholder="Search Demands" value="{{searchTerm}}">
            </div>

            <div class="md:w-2/12 text-md-end">
                <!-- Buttons for Search and Make PO -->
                <button type="submit" class="btn {{theme.buttonSecondary}} w-full mb-2">Search</button>
                <a class="btn {{theme.buttonSecondary}} w-full mb-2" role="button" onclick="makePO()">Make PO</a>
            </div>

            <input type="hidden" name="departmentFilter" value="{{ selectedDepartment }}">
        </div>

        <!-- Table of Demands -->
        <div id="purchaseDemandTable" class="overflow-x-auto mt-4">
            <table class="table {{theme.table}} w-full table-fixed border border-gray-600 text-left text-sm md:text-base text-white">
                <thead class="{{theme.tableHead}} bg-gray-900 text-white font-semibold">
                    <tr>
                        <th class="p-2 w-1/12">Select</th>
                        <th class="p-2 w-2/12">Demand Number</th>
                        <th class="p-2 w-2/12">PO Number</th>
                        <th class="p-2 w-2/12">Demand Date</th>
                        <th class="p-2 w-2/12">Department</th>
                        <th class="p-2 w-2/12">Demand By</th>
                        <th class="p-2 w-2/12">Inventory (Top 3)</th>
                        <th class="p-2 w-2/12">Approval</th>
                    </tr>
                </thead>
                <tbody id="tableData" class="{{theme.tableBody}} bg-gray-800 text-white">
                    {% for data in demand %}
                        <tr class="border-t border-gray-700 hover:bg-gray-700">
                            <td class="p-2"><input type="radio" name="item_checkbox"></td>
                            <td class="p-2">{{ data.PDNumber }}</td>
                            <td class="p-2">{{ data.PONumber }}</td>
                            <td class="p-2">{{ data.DemandDate }}</td>
                            <td class="p-2">{{ data.Department }}</td>
                            <td class="p-2">{{ data.Demandee }}</td>
                            <td class="p-2">{{ data.Name }}</td>
                            <td class="p-2">{{ data.Approval }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Update buttons based on selected demand
        $("#tableData").on("click", "input[type='radio']", function() {
            const selectedCode = $(this).closest("tr").find("td.demand").text();

            var button = $("#copyDemandButton");
            button.attr("href", "/purchasedemand/" + selectedCode + "/copy");

            button = $("#editDemandButton");
            button.attr("href", "/purchasedemand/" + selectedCode + "/edit");

            button = $("#deleteDemandButton");
            button.attr("href", "/purchasedemand/" + selectedCode + "/delete");

            button = $("#approveDemandButton");
            button.attr("href", "/purchasedemand/" + selectedCode + "/approve");
        });

        // Convert PD to PO
        async function makePO() {
            const response = await fetch('/options/suppliers');
            const suppliers = await response.json();

            showDropDown(suppliers, convertToPO, null, true);
        }

        async function convertToPO() {
            const supplier = document.getElementById('id_selectDropDown').value;
            const table = document.getElementById('purchaseDemandTable').querySelector('table');
            const radios = table.querySelectorAll('input[name="item_checkbox"]');

            let pdNumber = null;
            for (const radio of radios) {
                if (radio.checked) {
                    pdNumber = radio.closest("tr").children[1].textContent;
                    break;
                }
            }

            if (!pdNumber) {
                showMessage('No demand is selected');
                return;
            }

            const obj = { 'supplier': supplier, 'pdNumber': pdNumber };
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            const data = JSON.stringify(obj);
            const response = await fetch('/purchasedemand/makepo', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf },
            });

            if (response.status == 200) {
                const poNumber = await response.text();
                window.location.href = '/purchaseorder/' + poNumber + '/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return;
            }
        }

        // Initialize page
        window.addEventListener('load', async () => {
            // Populate departments dropdown
            let response = await fetch('/options/departments');
            const departments = await response.json();
            await appendOptions('departmentFilter', departments, '{{selectedDepartment}}');

            // Initialize department dropdown with Chosen.js
            $("#departmentFilter").chosen({
                search_contains: true,
                width: "100%"
            });
        });
    </script>
{% endblock %}
