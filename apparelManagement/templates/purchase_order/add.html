{% extends 'base.html' %}

{% block title %}
    Purchase Order Addition
{% endblock %}

{% block content %}
    {% csrf_token %}

    <!-- Main Order Form -->
    <form method="POST" id="orderForm" autocomplete="off" class="mb-6">
        <div class="card bg-base-100 shadow-lg p-6 space-y-4">
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="label">Supplier</label>
                    <select id="id_Supplier" name="Supplier" class="{{theme.dropdown}} w-full"></select>
                    <input type="text" id="allocInvCode" name="allocationInvCode" value="" hidden>
                </div>
                <div>
                    <label class="label">Delivery Date</label>
                    <div class="input input-bordered w-full flex items-center">
                        {{order.DeliveryDate}}
                    </div>
                </div>
                <div>
                    <label class="label">Tax</label>
                    <div class="input input-bordered w-full flex items-center">
                        {{order.Tax}}
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="submit" class="{{theme.buttonSecondary}}" onclick="submitForms()" type="button">
                    Save
                </button>
            </div>
        </div>
    </form>

    <!-- ðŸ“¦ Inventory Table -->
    <div id="inventoryTable" name="invTable">
        <form method="POST" id="inventoryForm" autocomplete="off">
            <div class="card bg-base-100 shadow-md p-6 space-y-3">
                <!-- Header Row -->
                <div class="grid grid-cols-12 gap-3 font-semibold text-sm text-neutral-content bg-neutral p-2 rounded">
                    <div class="col-span-4">Inventory Code</div>
                    <div class="col-span-1">Variant</div>
                    <div class="col-span-2">Quantity</div>
                    <div class="col-span-1">Price</div>
                    <div class="col-span-2">Currency</div>
                    <div class="col-span-1">Forex</div>
                    <div class="col-span-1">Actions</div>
                </div>

                <!-- First Row -->
                <div class="grid grid-cols-12 gap-3 items-center">
                    <div class="col-span-4 flex items-center gap-2">
                        <select class="{{theme.dropdown}} w-full" id="id_InventoryCode_1" name="InvCode"></select>
                        <span class="material-symbols-outlined cursor-pointer" onclick="openInvSearch(this)">search</span>
                    </div>
                    <div class="col-span-1">{{inventory.Variant}}</div>
                    <div class="col-span-2">{{inventory.Quantity}}</div>
                    <div class="col-span-1">{{inventory.Price}}</div>
                    <div class="col-span-2">
                        <select class="{{theme.dropdown}} w-full" id="id_Currency_1" name="Currency"></select>
                    </div>
                    <div class="col-span-1">{{inventory.Forex}}</div>
                    <div class="col-span-1 flex items-center gap-1">
                        <button class="{{theme.plusButton}}" type="button" onclick="openAllocation(this)">
                            <span class="material-symbols-outlined">more_vert</span>
                        </button>
                        <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">+</button>
                        <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">-</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- ðŸ§® Allocation Dialog -->
    <form method="POST" id="allocationForm" autocomplete="off">
        <div class="modal fade" id="allocationTable" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="{{theme.dialogBox}}">
                <div class="modal-content p-6 bg-base-100 rounded-lg shadow-lg">
                    <div class="{{theme.dialogBoxHeader}} mb-4">
                        <div class="{{theme.dialogBoxTitle}}" id="modalLabel">
                            Allocation
                        </div>
                    </div>

                    <div class="{{theme.dialogBoxBody}} space-y-3">
                        <div class="grid grid-cols-12 gap-4 font-semibold text-sm bg-neutral text-white p-2 rounded">
                            <div class="col-span-6">Order#</div>
                            <div class="col-span-4">Quantity</div>
                            <div class="col-span-2">Actions</div>
                        </div>

                        <div class="grid grid-cols-12 gap-4 items-center">
                            <div class="col-span-6">
                                <select class="{{theme.dropdown}} w-full" id="id_WorkOrder_1" name="WorkOrder" onchange="getDefaultQty(this)"></select>
                            </div>
                            <div class="col-span-4">
                                <input type="number" class="{{theme.textInput}} w-full" name="Quantity" min="0" onchange="changeQty()">
                            </div>
                            <div class="col-span-2 flex gap-1">
                                <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">+</button>
                                <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">-</button>
                            </div>
                        </div>
                    </div>

                    <div class="{{theme.dialogBoxFooter}} mt-6 flex flex-wrap items-center gap-4">
                        <label>Total Qty:</label>
                        <div id="totalQuantity"></div>
                        <label>|| Allocated Qty:</label>
                        <div id="allocatedQuantity"></div>
                        <label>|| Free Qty:</label>
                        <div id="freeQuantity"></div>
                        <button type="button" class="{{theme.buttonSecondary}}" data-bs-dismiss="modal" onclick="closeAllocation()">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </form>



    <script> //To run after page loads.
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //Styles Dropdown
            let response = await fetch('/options/suppliers');
            const styles = await response.json();
            await appendOptions('id_Supplier', styles);
            //Since this dropdown is not part of a table, we need manually apply search box
            $("#id_Supplier").chosen({
                search_contains: true,
                width: "100%"
            });

            //Inventory Cards dropdowns
            response = await fetch('/options/inventories');
            const inventories = await response.json();
            await appendOptions('id_InventoryCode_1', inventories);

            //Current dropdowns
            response = await fetch('/options/currencies');
            const currencies = await response.json();
            await appendOptions('id_Currency_1', currencies, 'PKR');

            //Inventory Cards dropdowns
            response = await fetch('/options/workorders');
            const workorders = await response.json();
            await appendOptions('id_WorkOrder_1', workorders);

            addSearchBox();

            delete response;

            hideLoadingIcon();
        });
    </script>

    <script>    //To handle alocation box
        async function openAllocation(source) {
            //Get the inventory and variant code.
            const inventoryCode = source.parentElement.parentElement.children[0].children[0].value;
            const variant = source.parentElement.parentElement.children[1].children[0].value;

            //Show error to user if inventory is not selected
            if (inventoryCode=='' || inventoryCode=='null') {
                alert('Select an inventory.');
                return ;
            }

            //Get url path, which will contain the PO number
            const urlPath = new URL(window.location.href).pathname;

            //get the allocation from server.
            const allocation = await getAllocation(inventoryCode, variant, urlPath);

            //Get the format of the allocation table
            const allocationTable = document.getElementById('allocationTable');

            const title = allocationTable.children[0].children[0].children[0].children[0];
            title.textContent = 'Allocation: ' + inventoryCode + ' '+variant;

            if (allocation != null) {
                const allocationArea = allocationTable.children[0].children[0].children[1];

                const previousRows = allocationArea.children;

                for (let i=previousRows.length - 1; i>1; i--) {
                    previousRows[i].remove();
                }
                delete previousRows;

                const firstRowPlusButton = allocationArea.children[1].children[2].children[0];

                for (let i=1; i<allocation.length; i++) {
                    addRow(firstRowPlusButton);
                }
                delete firstRowPluButton;
                
                const rows = allocationArea.children;
                removeSearchBox();
                for (let i=1; i<rows.length; i++) {
                    const workOrderBox = rows[i].children[0].children[0];
                    workOrderBox.value = (allocation[i-1].WorkOrder);

                    const qtyBox = rows[i].children[1].children[0];
                    qtyBox.value = (allocation[i-1].Quantity);

                }
                addSearchBox();
            }

            //The dummy box that contains inventory the currently selected inventory code
            const referenceBox = document.getElementById('allocInvCode');
            referenceBox.value = inventoryCode+'_'+variant;

            //Get the total quantity
            const totalQty = parseFloat(source.parentElement.parentElement.children[2].children[0].value);

            //Get the footer to set the summary
            const footer = allocationTable.children[0].children[0].children[2];

            //Set the value of total quantity.
            const totalQtyBox = footer.querySelector('#totalQuantity');
            totalQtyBox.textContent = totalQty;

            //Set the value of allocated quantity
            const allocQtyBox = footer.querySelector('#allocatedQuantity');
            allocQtyBox.textContent = 0;

            //Set the value of free qty to the difference of total and allocated quantity
            const freeQtyBox = footer.querySelector('#freeQuantity');
            freeQtyBox.textContent = totalQty;
            
            //convert the table to a bootstrap modal and show it to user.
            new bootstrap.Modal(allocationTable).show();

            changeQty();
        }

        function changeQty() {
            //Get the modal
            const dialogBox = document.getElementById('allocationTable').children[0].children[0];
            
            //Get all the rows in an array
            const rows = Array.from(dialogBox.children[1].children);
            
            //Remove header row
            rows.shift();

            let allocQty = 0.0;

            for (const row of rows) {
                //Get the first column
                const quantity = parseFloat(row.children[1].children[0].value);
                if (quantity) {
                    allocQty = allocQty + quantity;
                }
            }

            const footer = dialogBox.children[2];
            
            const totalQty = parseFloat(footer.querySelector('#totalQuantity').textContent);
            const allocatedQtyBox = footer.querySelector('#allocatedQuantity');
            const freeQtyBox = footer.querySelector('#freeQuantity');

            allocatedQtyBox.textContent = allocQty;
            freeQtyBox.textContent = totalQty - allocQty;
        }

        async function getAllocation(inventoryCode, variant, urlPath) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const obj = {'inventoryCode':inventoryCode,'variant':variant, 'urlPath':urlPath};
            const data = JSON.stringify(obj);

            const response = await fetch('alloc/get', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            return response.json();
        }

        async function closeAllocation() {
            //Get the selected inventory code and variant
            const invCodeVariant = document.getElementById('allocInvCode').value;
            const parts = invCodeVariant.split('_');
            const invCode = parts[0];
            const variant = parts[1];

            //Get the total allocated qty.
            const footer = document.getElementById('allocationTable').children[0].children[0].children[2];
            const allocatedQty = parseFloat(footer.querySelector('#allocatedQuantity').textContent);

            //Get the rows of inventory table.
            const InvTableRows = Array.from(document.getElementById('inventoryTable').children[0].children);
            InvTableRows.splice(0,1);
            
            for (const row of InvTableRows) {
                const invBox = row.children[0].children[0];
                const varBox = row.children[1].children[0];
                const qtyBox = row.children[2].children[0];
                
                if (invBox.value == invCode && varBox.value == variant) {
                    const totalQty = parseFloat(qtyBox.value);

                    if (totalQty < allocatedQty) {
                        qtyBox.value = allocatedQty;
                    }
                }
            }
            await submitForms();
        }
    </script>

    <script>    //To get the default qty of work order in alloc box
        async function getDefaultQty(source) {
            const workOrder = source.value;

            const allocInvVar = document.getElementById('allocInvCode').value;

            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            const obj = {'invVar':allocInvVar, 'workOrder':workOrder};
            const data = JSON.stringify(obj);

            const response = await fetch('/purchaseorder/defaultqty/get', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            const qty = await response.json();
            
            const qtyBox = source.parentElement.parentElement.children[1].children[0];

            qtyBox.value = qty;

            changeQty();
        }
    </script>

    <script> //To send data to server
        function submitForms() {
            const allForms = document.forms;

            const orderForm = allForms['orderForm']; 
            const inventoryForm = allForms['inventoryForm'];
            const allocationForm = allForms['allocationForm'];
            
            const order = orderForm.elements;

            let data = {};
             
            //Prepare the data for Style Group
            let group = 'order';
            for (const element of order) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            //Prepare the data for inventory Group
            data = formToTable('inventory', inventoryForm, data);

            //Prepare the data for alocaiton Group
            data = formToTable('allocation', allocationForm, data);
            
            submitData(data)
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);
            
            //console.log (csrf);
            const response = await fetch('', {
              method: 'POST',
              body: data,
              headers: { "X-CSRFToken": csrf},
            });

            if (response.status == 200) {
                const poNumber = await response.text();
                window.location.href = poNumber+'/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
            }
            
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('.row');
            //Remove unnecesary rows
            rows = dropElements(rows);

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>

    <script> //To run at the start of the page. This should be at the end of the page.
        $('#id_DeliveryDate').datepicker();
    </script>
{% endblock %}