{% extends 'base.html' %}

{% block title %}
    Requisition Form
{% endblock %} 

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    <!-- Selection Form -->
    <p>
        <form method="GET" id="ordersForm" autocomplete="off">
            <div class="row g-3 bg-info {{theme.justify}} {{theme.align}} {{theme.border}}">
                <div class="col-4 {{theme.align}} {{theme.justify}}">
                    <label>Work Order*:&nbsp; </label>
                    <select id="id_Order" class="{{theme.dropdown}}" name="order"></select>
                </div>
                <div class="col-4 {{theme.align}} {{theme.justify}}">
                    <label>Department*:&nbsp; </label>
                    <select id="id_Department" class="{{theme.dropdown}}" name="Department"></select>
                </div>
                <div class="col btn-group {{theme.align}} {{theme.textJustify}}">
                    <button type="submit" class="{{theme.buttonSecondary}}">          <!--Save Button-->
                        Refresh
                    </button>
                    <button id="submit" class="{{theme.buttonSecondary}}" onclick="addRequest()" type="button">          <!--Save Button-->
                        Add
                    </button>
                </div>
            </div>
            <div class="row g-1 {{theme.justify}} {{theme.align}} {{theme.border}}">
                <div class="col">
                    <select id="id_Inventories" class="{{theme.dropdown}}" name="inventories" multiple 
                    onchange="changeDropdown(this)" data-placeholder="Select Multiple Inventories"></select>
                </div>
                <div class="col {{theme.align}} {{theme.justify}}">
                    <div class="input-group">
                        <input id="id_Search" type="text" class="{{theme.textInput}}" placeholder="Apply Search"
                        value="{{search}}" name="search" onkeyup="changeSearch(this)">
                        <button type="button" class="{{theme.minusButton}}" onclick="clearInput(this)">
                            <span>X</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </p>

    <!-- Inventory Selection Table -->
    <div id="inventoryTable" name="invTable">
        <form method="POST" id="inventoryForm" autocomplete="off">
            <div class="row mt-3 {{theme.justify}} {{theme.textJustify}} bg-dark text-white" row="0">
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        <input class="form-check-input" type="checkbox" value="" onclick="selectAll(this)">
                    </div>
                </div>
                <div class="col-3">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Name
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Variant
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Cons.
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Required
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Ordered
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Received
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Requested
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Issued
                    </div>
                </div>
                <div class="col-1">
                    <div class="{{theme.secondaryHeading}} {{theme.textJustify}}">
                        Balance
                    </div>
                </div>
            </div>
            {% for data in entries %}
                <div class="row mt-1 {{theme.justify}} {{theme.textJustify}}" row="{{forloop.counter}}">
                    <div class="col-1">
                        <input class="form-check-input" type="checkbox">
                    </div>
                    <div class="col-3">
                        <input type="text" class="{{theme.textInput}}" value="{{data.InventoryCode}}" name="InventoryCode" hidden>
                        <input type="text" class="{{theme.textInput}}" value="{{data.Name}}" name="Name" readonly>
                    </div>
                    <div class="col-1">
                        <input type="text" class="{{theme.textInput}}" value="{{data.Variant}}" name="Variant" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Consumption}}" name="Consumption" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Required}}" name="Required" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Ordered}}" name="Ordered" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Received}}" name="Received" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Requested}}" name="Requested" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" class="{{theme.textInput}}" value="{{data.Issued}}" name="Issued" readonly>
                    </div>
                    <div class="col-1">
                        <input type="number" max="{{data.Balance}}" class="{{theme.textInput}}" value="{{data.Balance}}" name="Balance" onchange="checkQty(this)">
                    </div>
                </div>
            {% endfor %}
        </form>
    </div>

    <script> //To run when the page loads
        window.addEventListener('load', async () => {
            showLoadingIcon();

            //orders Dropdown
            let response = await fetch('/options/workorders');
            const orders = await response.json();
            await appendOptions('id_Order', orders, Number("{{order}}"));
            //Since this dropdown is not part of a table, we need manually apply search box
            $("#id_Order").chosen({
                search_contains: true,
                width: "100%"
            });

            //departments Dropdown
            response = await fetch('/options/departments');
            const departments = await response.json();
            await appendOptions('id_Department', departments, ("{{department}}"));
            //Since this dropdown is not part of a table, we need manually apply search box
            $("#id_Department").chosen({
                search_contains: true,
                width: "100%"
            });

            const inventories = {{ invs|safe }};
            await appendOptions('id_Inventories', inventories);
            $("#id_Inventories").chosen({
                search_contains: true,
                width: "100%"
            });

            hideLoadingIcon();
        });
    </script>

    <script> //To select all visible rows
        function selectAll(box) {
            const checkStatus = box.checked;

            const table = box.parentElement.parentElement.parentElement.parentElement.parentElement;
            const numberOfRows = table.children[0].children.length;

            for (let i=1; i<numberOfRows;i++) {
                const row = table.querySelector('[row="'+i+'"]');
                const rowCheck = row.children[0].children[0];
                const filterStatus = (row.style.display === '');

                rowCheck.checked = false;

                if (filterStatus) {
                    rowCheck.checked = checkStatus;
                }
            } 
        }
    </script>

    <script> //To filter rows based on search items
        function changeSearch(source) {
            //get search term and make it case insenstive
            const searchTerm = source.value.toLowerCase();

            //Get the table in html form
            const tableHTML = document.getElementById('inventoryTable').children[0].children;

            //Conver the html table to array and remove header
            const table = Array.from(tableHTML);
            table.shift();

            for (const row of table) {
                const cells = row.children;

                let matchFlag = false;
                for (const cell of cells) {
                    const cellValue = cell.children[0].value.toLowerCase();

                    if (cellValue.includes(searchTerm)) {
                        matchFlag = true;
                        break;
                    }
                }
                row.style.display = matchFlag ? '':'none';
            }

            //Set the table unchecked to avoid any problems
            const checkBox = tableHTML[0].children[0].children[0].children[0];
            checkBox.checked = false;
            selectAll(checkBox);
        }

        function changeDropdown(source) {
            const options = source.options;
            const selectedCodes = [];
            for (const option of options) {
                if (option.selected) {
                    selectedCodes.push(option.value)
                }
            }

            //Get the table in html form
            const tableHTML = document.getElementById('inventoryTable').children[0].children;

            //Conver the html table to array and remove header
            const table = Array.from(tableHTML);
            table.shift();

            if (selectedCodes.length != 0) {
                for (const row of table) {
                    const code = row.children[1].children[0].value;
    
                    const flag = selectedCodes.includes(code);
                    row.style.display = flag ? '':'none';
                }
            } else {
                for (const row of table) {
                    row.style.display = '';
                }
            }
            
            //Set the table unchecked to avoid any problems
            const checkBox = tableHTML[0].children[0].children[0].children[0];
            checkBox.checked = false;
            selectAll(checkBox);
        }

        function clearInput(source) {
            searchBox = source.parentElement.children[0];
            searchBox.value = '';
            changeSearch(searchBox);
            searchBox.focus();
        }
    </script>

    <script> //To make requisition for selected items
        async function addRequest() {
            const inventoryForm = document.getElementById('inventoryForm');
            const rows = inventoryForm.children;

            let selectedRows = [];

            for (const row of rows) {
                const rowNumber = row.getAttribute('row');
                const checkStatus = row.children[0].children[0].checked;

                if (rowNumber>0 && checkStatus) {
                    selectedRows.push(row);
                }
            }
            delete rows, inventoryForm;

            if (selectedRows.length === 0) {
                alert('No inventory is selected');
                return
            }
            let data = {};
            for (const row of selectedRows) {
                data = prepareReqData(row, data);
            }

            const reqForm = document.getElementById('ordersForm');
            const orderData = reqForm.children[0].children;

            const workOrder = orderData[0].children[1].value;
            if (workOrder === 'null') {
                alert ('Please select an order');
                return
            }

            const department = orderData[1].children[1].value;     
            if (department === 'null') {
                alert('Please select your department');
                return
            }
            
            data['req_WorkOrder'] = workOrder;
            data['req_Department'] = department;

            data = JSON.stringify(data);

            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            const response = await fetch('', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            if (response.ok) {
                const reqNumber = await response.text();
                window.open(reqNumber+'/edit', '_blank');
                window.location.reload();
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
            }
        }

        function prepareReqData(row, data) {
            const inventoryCode = row.querySelector("[name='InventoryCode']").value;
            const variant = row.querySelector("[name='Variant']").value;
            const Quantity = row.querySelector("[name='Balance']").value;
            const rowNum = row.getAttribute('row');

            data['data_InventoryCode_'+rowNum] = inventoryCode;
            data['data_Variant_'+rowNum] = variant;
            data['data_Quantity_'+rowNum] = Quantity;


            return data;
        }

    </script>

    <script> //This is in response to a bug where would add more qty than received
        function checkQty(source) {
            const qty = parseFloat(source.value);
            const maxQty = parseFloat(source.getAttribute('max'));

            if (maxQty < qty) {
                source.value = maxQty;
            }
        }
    </script>

    <script> //Run this at the time of page loading. This should be at the end of all scripts
        searchBox = document.getElementById('id_Search');
        changeSearch(searchBox);
    </script>
{% endblock %}