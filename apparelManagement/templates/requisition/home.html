{% extends 'base.html' %}

{% block title %}
    Requisitions
{% endblock %}

{% block content %}
    <div class="{{theme.border}} p-6 rounded-xl shadow-md bg-inherit space-y-6">

        <!-- FILTERS & ACTION BUTTONS -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

            <!-- Department Filter -->
            <form action="{% url 'requisition' %}" method="get" class="w-full md:w-auto">
                <label class="block text-white font-semibold mb-1">Filter by Department</label>
                <select id="departmentFilter" name="departmentFilter" onchange="this.form.submit()" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600">
                    <option value="">---------</option>
                </select>
                <input type="hidden" name="searchTerm" value="{{ searchTerm }}">
                <input type="hidden" name="requisitionNumber" value="{{ selectedRequisition }}">
            </form>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
                <a href="/requisition/add/order" class="{{theme.buttonSecondary}} " target="_blank">Add For Order</a>
                <a href="/requisition/add/inv" class="{{theme.buttonSecondary}}" target="_blank">Add For Inventory</a>
                <a id="editReqButton" class="{{theme.buttonSecondary}} " target="_blank">Edit</a>
                <a id="addIssueButton" class="{{theme.buttonSecondary}} " target="_blank">Issue</a>
            </div>
        </div>

        <!-- SEARCH BAR -->
        <form action="{% url 'requisition' %}" method="get" class="flex flex-col md:flex-row gap-3 md:items-center">
            <div class="md:w-2/12">
                <input type="number" name="requisitionNumber" placeholder="Requisition Number" value="{{selectedRequisition}}"
                    class="{{theme.textInput}} w-full text-white bg-gray-800 border border-gray-600 rounded-md p-2" />
            </div>
            <div class="md:w-2/12">
                <label class="block text-white font-semibold mb-1">Filter by Status</label>
                <select name="statusFilter" onchange="this.form.submit()" class="{{theme.dropdown}} w-full text-white bg-gray-800 border-gray-600">
                    <option value="Pending" {% if selectedStatus == "Pending" %}selected{% endif %}> Pending  </option>
                    <option value="Closed" {% if selectedStatus == "Closed" %}selected{% endif %}> Closed  </option>
                </select>
            </div>
            <div class="flex-1">
                <input type="text" name="searchTerm" placeholder="Search Requisition" value="{{searchTerm}}"
                    class="{{theme.textInput}} w-full text-white bg-gray-800 border border-gray-600 rounded-md p-2" />
                <input type="hidden" name="departmentFilter" value="{{ selectedDepartment }}">
            </div>
            <div class="md:w-32">
                <button type="submit" class="{{theme.buttonSecondary}} ">Search</button>
            </div>
        </form>

        <!-- TABLE -->
        <div id="requisitionTable" class="overflow-x-auto mt-4">
            <table class="{{theme.table}} w-full table-fixed border border-gray-600 text-left text-sm md:text-base text-white">
                <thead class="{{theme.tableHead}} bg-gray-900 text-white font-semibold">
                    <tr>
                        <th class="p-2 w-1/12">Select</th>
                        <th class="p-2 w-2/12">Requisition#</th>
                        <th class="p-2 w-2/12">Date</th>
                        <th class="p-2 w-2/12">Time</th>
                        <th class="p-2 w-2/12">Department</th>
                        <th class="p-2 w-2/12">Demand By</th>
                        <th class="p-2 w-2/12">Inventory (Top 3)</th>
                    </tr>
                </thead>
                <tbody id="tableData" class="{{theme.tableBody}} bg-gray-800 text-white">
                    {% for data in req %}
                        <tr class="border-t border-gray-700 hover:bg-gray-700">
                            <td class="p-2"><input type="radio" name="item_checkbox" class="accent-indigo-500"></td>
                            <td class="p-2 requisition font-mono">{{ data.id }}</td>
                            <td class="p-2">{{ data.Date }}</td>
                            <td class="p-2">{{ data.Time }}</td>
                            <td class="p-2">{{ data.Department }}</td>
                            <td class="p-2">{{ data.RequestBy }}</td>
                            <td class="p-2">{{ data.Name }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- SCRIPT -->
        <script>
            // Update buttons on row selection
            $("#tableData").on("click", "input[type='radio']", function () {
                const selectedCode = $(this).closest("tr").find("td.requisition").text().trim();
                $("#editReqButton").attr("href", "/requisition/" + selectedCode + "/edit");
                $("#addIssueButton").attr("href", "/issuance/add?req=" + selectedCode);
            });

            // Populate department dropdown on load
            window.addEventListener('load', async () => {
                let response = await fetch('/options/departments');
                const departments = await response.json();
                await appendOptions('departmentFilter', departments, '{{selectedDepartment}}');
                $("#departmentFilter").chosen({
                    search_contains: true,
                    width: "100%"
                });
            });
        </script>
    </div>
{% endblock %}
