{% extends 'prodManagement/base.html' %}

{% block title %}
    Style Bulletin Update
{% endblock title %}

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    <form method="POST" id="bulletinForm" autocomplete="off">  
        <div class="{{theme.border}}">
            <div class="grid grid-cols-2 my-2 {{theme.justify}} {{theme.align}}">
                <div class="flex col-[1/2] items-center">
                    <label class="mx-2 whitespace-nowrap">Style:&nbsp; </label>
                    <input type="text" class="flex-grow {{theme.textInput}}" name="StyleCard" value="{{data.StyleCard}}" readonly>
                </div>
                <div class="flex col-[2/3] btn-group {{theme.align}} justify-end ml-1">
                    <button type="button" class="{{theme.buttonBasic}} mx-2" onclick="SendForm()">Save</button>
                    <a class="{{theme.buttonBasic}}" role="button" href="{% url 'duplicateStyleBulletin' pk=data.id%}">Duplicate</a>
                </div>
            </div>
        </div>
    </form>

    <form method="POST" id="bulletinDetailsForm" autocomplete="off">
        <div class="{{theme.border}}">
            <div class="grid grid-cols-5 mt-4 px-3 {{theme.border}} {{theme.tableHead}}" row="0">
                <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Operation
                    </div>
                </div>
                <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Section
                    </div>
                </div>
                <div class="flex col-[5/6] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            {% for operation in operations %}
                <div class="grid grid-cols-5 x-3 {{theme.justify}} {{theme.align}} {{theme.border}}" row="{{forloop.counter}}">    
                    <div>
                        <input name="id" value="{{operation.id}}" hidden="true">
                    </div>

                    <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                        <select id="id_Operation_{{forloop.counter}}" class="flex-grow {{theme.dropdown}}" name="Operation"
                            onclick="showSearchBox(this, '/options/operations', updateSection)">
                        </select>
                    </div>
                    <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                        <select id="id_Section_{{forloop.counter}}" class="flex-grow {{theme.dropdown}}" name="Section">

                        </select>
                    </div>
                    <div class="flex col-[5/6] space-x-1 {{theme.align}} {{theme.justify}}">
                        <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                            <span>+</span>
                        </button>
                        <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                            <span>-</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </form>

    <script>    //To update section for an operation
        async function updateSection(source) {
            const selectedCode = source.value;

            const response = await fetch(`/options/section/${selectedCode}`);
            const section = await response.json();

            const sectionSelect = source.parentElement.parentElement.children[2].children[0];
            sectionSelect.value = section;
        }
    </script>

    <script> //To run when the page loads
        window.addEventListener('load', async () => {
            showLoadingIcon();

            let response = await fetch('/options/operations/sections');
            const sections = await response.json();

            const operationsData = {{ operationsJson|safe }};
            for (const [index, data] of operationsData.entries()) {
                await appendOptions(`id_Section_${index+1}`, sections, data.Section);

                response = await fetch(`/options/operations?code=${data.Operation}`);
                const options = await response.json();

                await appendOptions(`id_Operation_${index+1}`, options, data.Operation);
            }                
            hideLoadingIcon();
        });
    </script>

    <script>    //To send data to server
        async function SendForm() {
            showLoadingIcon();
            const forms = document.forms;

            const operationsForm = forms['bulletinDetailsForm'];

            const data = formToTable('operations', bulletinDetailsForm, {});

            await submitData(data);

            hideLoadingIcon();
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);

            const response = await fetch('', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            if (response.ok){
                showMessage(await response.text(), 3, '{{theme.successBox}}');
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('[row]');
            //Remove unnecesary rows
            rows = dropElements(rows);
            

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>
{% endblock content %}