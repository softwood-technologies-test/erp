{% extends 'prodManagement/base.html' %}

{% block title %}
    Style Bulletin Update
{% endblock title %}

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    <form method="POST" id="bulletinForm" autocomplete="off">  
        <div class="{{theme.border}}">
            <div class="grid grid-cols-2 my-2 {{theme.justify}} {{theme.align}}">
                <div class="flex col-[1/2] items-center">
                    <label class="mx-2 whitespace-nowrap">Style:&nbsp; </label>
                    <input type="text" class="flex-grow {{theme.textInput}}" name="StyleCard" value="{{data.StyleCard}}" readonly>
                </div>
                <div class="flex col-[2/3] btn-group {{theme.align}} justify-end ml-1">
                    <button type="button" class="{{theme.buttonBasic}}" onclick="SendForm()">Save</button>
                    <a class="{{theme.buttonBasic}}" role="button" href="{% url 'duplicateStyleBulletin' pk=data.id%}">Duplicate</a>
                    <a class="{{theme.buttonBasic}}" role="button" onclick="showSummary()">Summarise</a>
                </div>
            </div>
        </div>
    </form>

    <form method="POST" id="bulletinDetailsForm" autocomplete="off">
        <div class="{{theme.border}}">
            <div class="grid grid-cols-5 mt-4 px-3 {{theme.border}} {{theme.tableHead}}" row="0">
                <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Operation
                    </div>
                </div>
                <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Section
                    </div>
                </div>
                <div class="flex col-[5/6] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            {% for operation in operations %}
                <div class="grid grid-cols-5 x-3 {{theme.justify}} {{theme.align}} {{theme.border}}" row="{{forloop.counter}}">    
                    <div>
                        <input name="id" value="{{operation.id}}" hidden="true">
                    </div>

                    <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                        <select id="id_Operation_{{forloop.counter}}" class="flex-grow {{theme.dropdown}}" name="Operation"
                            onclick="showSearchBox(this, '/options/operations', updateSection)">
                        </select>
                    </div>
                    <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                        <select id="id_Section_{{forloop.counter}}" class="flex-grow {{theme.dropdown}}" name="Section">

                        </select>
                    </div>
                    <div class="flex col-[5/6] space-x-1 {{theme.align}} {{theme.justify}}">
                        <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                            <span>+</span>
                        </button>
                        <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                            <span>-</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </form>

    <div id="summaryBox" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Style Bulletin Summary</h2>
            <div class="overflow-x-auto">
                <table class="{{theme.table}}">
                    <thead class="{{theme.tableHead}}">
                        <tr>
                            <th>Description</th>
                            <th>Previous</th>
                            <th>Current</th>
                          </tr>
                    </thead>
                    <tbody class="{{theme.tableBody}}">
                        <tr class="{{theme.tableBodyRow}}">
                            <td>Total SAM</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="{{theme.tableBodyRow}}">
                            <td>Total Rate</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="{{theme.tableBodyRow}}">
                            <td>Average Skill Level</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-action mt-4 justify-end">
                <button class="{{theme.buttonBasic}}" onclick="hideMessageBox()">OK</button>
            </div>
        </div>
    </div>

    <script>    //To update section for an operation
        async function updateSection(source) {
            const selectedCode = source.value;

            const response = await fetch(`/options/section/${selectedCode}`);
            const section = await response.json();

            const sectionSelect = source.parentElement.parentElement.children[2].children[0];
            sectionSelect.value = section;
        }
    </script>

    <script>    //To summarize the OB
        async function showSummary() {
            showLoadingIcon()
            const operationsForm = document.forms['bulletinDetailsForm'];

            const data = formToTable('operations', operationsForm, {});
            
            const pathName = (new URL(window.location.href)).pathname.split('/')
            const id = pathName[3]

            data['bulletin_Id'] = id

            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            const response = await fetch("{% url 'summariseSytleBulletin' %}", {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { "X-CSRFToken": csrf},
            });

            const summary = await response.json();
            
            showSummaryBox(summary);

            hideLoadingIcon();
        }

        function showSummaryBox(summary) {
            const summaryBox = document.getElementById('summaryBox');
            const rows = summaryBox.getElementsByTagName('tbody')[0].rows;

            // Format SMV values to at most two decimal places
            const smvBefore = parseFloat(summary['SMV']['Before']).toFixed(2);
            const smvAfter = parseFloat(summary['SMV']['After']).toFixed(2);
            rows[0].children[1].textContent = `${smvBefore} mins`;
            rows[0].children[2].textContent = `${smvAfter} mins`;

            // Format Rate values to at most two decimal places
            const rateBefore = parseFloat(summary['Rate']['Before']).toFixed(2);
            const rateAfter = parseFloat(summary['Rate']['After']).toFixed(2);
            rows[1].children[1].textContent = `Rs. ${rateBefore}/-`;
            rows[1].children[2].textContent = `Rs. ${rateAfter}/-`;

            rows[2].children[1].textContent = `${summary['SkillLevel']['Before']}`;
            rows[2].children[2].textContent = `${summary['SkillLevel']['After']}`;

            summaryBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            const summaryBox = document.getElementById('summaryBox');
            summaryBox.classList.add('hidden');
        }
    </script>

    <script> //To run when the page loads
        window.addEventListener('load', async () => {
            showLoadingIcon();

            let response = await fetch('/options/operations/sections');
            const sections = await response.json();

            const operationsData = {{ operationsJson|safe }};
            for (const [index, data] of operationsData.entries()) {
                await appendOptions(`id_Section_${index+1}`, sections, data.Section);

                response = await fetch(`/options/operations?code=${data.Operation}`);
                const options = await response.json();

                await appendOptions(`id_Operation_${index+1}`, options, data.Operation);
            }                
            hideLoadingIcon();
        });
    </script>

    <script>    //To send data to server
        async function SendForm() {
            showLoadingIcon();
            const forms = document.forms;

            const operationsForm = forms['bulletinDetailsForm'];

            const data = formToTable('operations', operationsForm, {});

            await submitData(data);

            hideLoadingIcon();
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);

            const response = await fetch('', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            if (response.ok){
                showMessage(await response.text(), 3, '{{theme.successBox}}');
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('[row]');
            //Remove unnecesary rows
            rows = dropElements(rows);
            

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>
{% endblock content %}