{% extends 'prodManagement/base.html' %}

{% block title %}
    Style Bulletin
{% endblock title %}

{% block content %}
    {% csrf_token %}          <!--This is to protect against CSRF attacks-->
    <form method="POST" id="bulletinForm" autocomplete="off">  
        <div class="{{theme.border}}">
            <div class="grid grid-cols-2 my-2 {{theme.justify}} {{theme.align}}">
                <div class="flex col-[1/2] items-center">
                    <label class="mx-2 whitespace-nowrap">Style:&nbsp; </label>
                    <select id="id_Style" class="{{theme.dropdown}}" name="StyleCard" onclick="showSearchBox(this, '/producitivty/bulletin/styles/missing')" required>
                    </select>
                </div>
                <div class="flex col-[2/3] items-center">
                    <button type="button" class="{{theme.buttonBasic}} mx-2" onclick="SendForm()">Save</button>
                </div>
            </div>
        </div>
    </form>

    <form method="POST" id="bulletinDetailsForm" autocomplete="off">
        <div class="{{theme.border}}">
            <div class="grid grid-cols-5 mt-4 px-3 {{theme.border}} {{theme.tableHead}}" row="0">
                <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Operation
                    </div>
                </div>
                <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Section
                    </div>
                </div>
                <div class="flex col-[5/6] {{theme.align}} {{theme.justify}}">
                    <div class="{{theme.primaryHeading}} {{theme.textJustify}}">
                        Actions
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-5 x-3 {{theme.justify}} {{theme.align}} {{theme.border}}" row="1">
                <div class="flex col-[1/3] {{theme.align}} {{theme.justify}}">
                    <select id="id_Operation_1" class="flex-grow {{theme.dropdown}}" name="Operation"
                    onclick="showSearchBox(this, '/options/operations', updateSection)">
                    </select>
                </div>
                <div class="flex col-[3/5] {{theme.align}} {{theme.justify}}">
                    <select id="id_Section_1" class="flex-grow {{theme.dropdown}}" name="Section">

                    </select>
                </div>
                <div class="flex col-[5/6] space-x-1 {{theme.align}} {{theme.justify}}">
                    <button class="{{theme.plusButton}}" type="button" onclick="addRow(this)">
                        <span>+</span>
                    </button>
                    <button class="{{theme.minusButton}}" type="button" onclick="removeRow(this)">
                        <span>-</span>
                    </button>
                </div>
            </div>
        </div>
    </form>

    <script>    //To update section for an operation
        async function updateSection(source) {
            const selectedCode = source.value;

            const response = await fetch(`/options/section/${selectedCode}`);
            const section = await response.json();

            const sectionSelect = source.parentElement.parentElement.children[1].children[0];

            sectionSelect.value = section;
        }
    </script>

    <script>    //To run when the page loads
        window.addEventListener('load', async () => {
            showLoadingIcon();

            let response = await fetch('/options/operations/sections');
            const sections = await response.json();
            await appendOptions('id_Section_1', sections);

            hideLoadingIcon();
        });
    </script>  
    
    <script>    //To send data to server
        async function SendForm() {
            const forms = document.forms;

            const bulletinForm = forms['bulletinForm'];
            const bulletinDetailsForm = forms['bulletinDetailsForm'];

            const bulletin = bulletinForm.elements;

            let data = {};
            //Prepare the data for Bulletin Group
            let group = 'bulletin';
            for (const element of bulletin) {
                if (element.name) {
                    data[group+'_'+element.name] = element.value;
                }   
            }

            data = formToTable('operations', bulletinDetailsForm, data);

            await submitData(data);
        }

        //Convert data to Json and send to server
        async function submitData(obj) {
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const data = JSON.stringify(obj);

            const response = await fetch('', {
                method: 'POST',
                body: data,
                headers: { "X-CSRFToken": csrf},
            });

            if (response.ok){
                const bulletinNumber = await response.text();
                window.location.href = bulletinNumber+'/edit';
            } else {
                const errorMessage = await response.text();
                showMessage(errorMessage);
                return
            }
        }

        function formToTable(group, form, data){
            let rows = form.querySelectorAll('[row]');
            //Remove unnecesary rows
            rows = dropElements(rows);
            

            for (const row of rows) {
                let rowNum = row.getAttribute('row');
                let cols = row.children;
                //Remove unnecessary columns
                cols = dropElements(cols, cols.length-1, cols.length-1);

                for (const col of cols) {
                    name = col.firstElementChild.name+'_'+rowNum;
                    value = col.firstElementChild.value;
                    data[group+'_'+name] = value;               
                }
            }
            return data;
        }

        function dropElements(obj, startFrom=0, endAt=0) {
            const arr = Object.values(obj);

            arr.splice(startFrom, endAt - startFrom + 1);

            return arr;
        }
    </script>
{% endblock content %}